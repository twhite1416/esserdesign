Array.prototype.deleteFirst=function(a){for(var b=0;b<this.length;b++){if(this[b]==a){this.splice(b,1);return true}}return false};Array.prototype.stableSort=function(a){for(var b=0;b<this.length;b++){this[b].__arrayPos=b}return this.sort(Array.__stableSorter(a))};Array.__stableSorter=function(a){return function(b,c){var d=a(b,c);if(!d){return b.__arrayPos-c.__arrayPos}return d}};Array.prototype.equals=function(a){if(!a)return false;if(this.length!=a.length)return false;for(var b=0;b<this.length;b++){var c=this[b];var d=a[b];if(c.equals&&typeof c.equals=="function"){if(!c.equals(d))return false}else if(c!=d){return false}}return true};Array.prototype.rotate=function(a){if(a){this.unshift(this.pop());return this[0]}else{this.push(this.shift());return this[this.length-1]}};Array.prototype.pick=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.flatten=function(){var a=[];for(var b=0;b<this.length;b++){var c=this[b];if(c.flatten){var d=c.flatten();for(var e=0;e<d.length;e++){a[a.length]=d[e]}}else{a[a.length]=c}}return a};Array.prototype.take=function(){var a=[];for(var b=0;b<this.length;b++){var c=[];for(var d=0;d<arguments.length;d++){c[d]=this[b][arguments[d]]}a[b]=c}return a};if(!Array.prototype.pluck){Array.prototype.pluck=function(a){var b=[];for(var c=0;c<this.length;c++){b[c]=this[c][a]}return b}}Array.prototype.set=function(a,b){for(var c=0;c<this.length;c++){this[c][a]=b}};Array.prototype.allWith=function(){var a=[];topLoop:for(var b=0;b<this.length;b++){var c=this[b];for(var d=0;d<arguments.length;d++){if(!this[b][arguments[d]])continue topLoop}a[a.length]=c}return a};Element.prototype.append=function(){for(var a=0;a<arguments.length;a++){if(typeof arguments[a]=="string"){this.appendChild(T(arguments[a]))}else{this.appendChild(arguments[a])}}};if(!Function.prototype.bind){Function.prototype.bind=function(a){var b=this;return function(){return b.apply(a,arguments)}}}if(!Array.prototype.last){Array.prototype.last=function(){return this[this.length-1]}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(a){for(var b=0;b<this.length;b++)if(a==this[b])return b;return-1}}if(!Array.prototype.includes){Array.prototype.includes=function(a){return this.indexOf(a)>=0}}Array.prototype.map=function(a){var b=new Array(this.length);if(a)for(var c=0;c<this.length;c++)b[c]=a(this[c],c,this);else for(var c=0;c<this.length;c++)b[c]=this[c];return b};Array.prototype.forEach=function(a){for(var b=0;b<this.length;b++)a(this[b],b,this)};if(!Array.prototype.reduce){Array.prototype.reduce=function(a,b){var c=0;if(arguments.length==1){b=this[0];c++}for(;c<this.length;c++){b=a(b,this[c],c,this)}return b}}if(!Array.prototype.find){Array.prototype.find=function(a){for(var b=0;b<this.length;b++){if(a(this[b],b,this))return this[b]}}}if(!String.prototype.capitalize){String.prototype.capitalize=function(){return this.replace(/^./,this.slice(0,1).toUpperCase())}}if(!String.prototype.escape){String.prototype.escape=function(){return'"'+this.replace(/"/g,'\\"')+'"'}}if(!String.prototype.splice){String.prototype.splice=function(a,b,c){return this.slice(0,a)+c+this.slice(a+b)}}if(!String.prototype.strip){String.prototype.strip=function(){return this.replace(/^\s+|\s+$/g,"")}}if(!window["$A"]){$A=function(a){var b=new Array(a.length);for(var c=0;c<a.length;c++)b[c]=a[c];return b}}if(!window["$"]){$=function(a){return document.getElementById(a)}}if(!Math.sinh){Math.sinh=function(a){return.5*(Math.exp(a)-Math.exp(-a))};Math.asinh=function(a){return Math.log(a+Math.sqrt(a*a+1))}}if(!Math.cosh){Math.cosh=function(a){return.5*(Math.exp(a)+Math.exp(-a))};Math.acosh=function(a){return Math.log(a+Math.sqrt(a*a-1))}}E=function(a,b,c){var d=document.createElement(a);if(b){if(typeof b=="string"){d.innerHTML=b;b=c}else if(b.DOCUMENT_NODE){d.appendChild(b);b=c}if(b){if(b.style){var e=b.style;b=Object.clone(b);delete b.style;Object.forceExtend(d.style,e)}if(b.content){if(typeof b.content=="string"){d.appendChild(T(b.content))}else{d.appendChild(b.content)}b=Object.clone(b);delete b.content}Object.forceExtend(d,b)}}return d};E.lastCanvasId=0;E.canvas=function(a,b,c){var d="canvas-uuid-"+E.lastCanvasId;E.lastCanvasId++;if(!c)c={};return E("canvas",Object.extend(c,{id:d,width:a,height:b}))};T=function(a){return document.createTextNode(a)};Object.forceExtend=function(a,b){for(var c in b){try{a[c]=b[c]}catch(d){}}return a};if(!Object.extend)Object.extend=Object.forceExtend;Object.conditionalExtend=function(a,b){for(var c in b){if(a[c]==null)a[c]=b[c]}return a};Object.clone=function(src){if(!src||src==true)return src;switch(typeof src){case"string":return Object.extend(src+"",src);break;case"number":return src;break;case"function":obj=eval(src.toSource());return Object.extend(obj,src);break;case"object":if(src instanceof Array){return Object.extend([],src)}else{return Object.extend({},src)}break}};Object.loadImage=function(a,b){var c=new Image;if(b)c.onload=b;c.src=a;return c};Object.isImageLoaded=function(a){if(a.tagName=="CANVAS")return true;if(!a.complete)return false;if(a.naturalWidth==null)return true;return!!a.naturalWidth};Object.sum=function(a,b){if(a instanceof Array){if(b instanceof Array){var c=[];for(var d=0;d<a.length;d++){c[d]=a[d]+b[d]}return c}else{return a.map(function(a){return a+b})}}else if(b instanceof Array){return b.map(function(b){return b+a})}else{return a+b}};Object.sub=function(a,b){if(a instanceof Array){if(b instanceof Array){var c=[];for(var d=0;d<a.length;d++){c[d]=a[d]-b[d]}return c}else{return a.map(function(a){return a-b})}}else if(b instanceof Array){return b.map(function(b){return a-b})}else{return a-b}};if(!window.Mouse)Mouse={};Mouse.getRelativeCoords=function(a,b){var c={x:0,y:0};var d=0;var e=0;var f=a;while(f){d+=f.offsetLeft;e+=f.offsetTop;f=f.offsetParent}c.x=b.pageX-d;c.y=b.pageY-e;return c};Browser=function(){var a=window.navigator.userAgent;var b=a.match(/KHTML/);var c=a.match(/Gecko/);var d=a.match(/WebKit\/\d+/);var e=a.match(/Explorer/);if(b)return"KHTML";if(c)return"Gecko";if(d)return"Webkit";if(e)return"IE";return"UNKNOWN"}();Mouse.LEFT=0;Mouse.MIDDLE=1;Mouse.RIGHT=2;if(Browser=="IE"){Mouse.LEFT=1;Mouse.MIDDLE=4}Klass=function(){var a=function(){this.initialize.apply(this,arguments)};a.ancestors=$A(arguments);a.prototype={};for(var b=0;b<arguments.length;b++){var c=arguments[b];if(c.prototype){Object.extend(a.prototype,c.prototype)}else{Object.extend(a.prototype,c)}}Object.extend(a,a.prototype);return a};Curves={angularDistance:function(a,b){var c=Math.PI*2;var d=(b-a)%c;if(d>Math.PI)d-=c;if(d<-Math.PI)d+=c;return d},linePoint:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c]},quadraticPoint:function(a,b,c,d){var e=a[0]+(b[0]-a[0])*d;var f=b[0]+(c[0]-b[0])*d;var g=e+(f-e)*d;var h=a[1]+(b[1]-a[1])*d;var i=b[1]+(c[1]-b[1])*d;var j=h+(i-h)*d;return[g,j]},cubicPoint:function(a,b,c,d,e){var f=a[0]*3;var g=b[0]*3;var h=c[0]*3;var i=a[1]*3;var j=b[1]*3;var k=c[1]*3;return[a[0]+e*(g-f+e*(f-2*g+h+e*(g-a[0]-h+d[0]))),a[1]+e*(j-i+e*(i-2*j+k+e*(j-a[1]-k+d[1])))]},linearValue:function(a,b,c){return a+(b-a)*c},quadraticValue:function(a,b,c,d){var e=a+(b-a)*d;var f=b+(c-b)*d;return e+(f-e)*d},cubicValue:function(a,b,c,d,e){var f=a*3,g=b*3,h=c*3;return a+e*(g-f+e*(f-2*g+h+e*(g-a-h+d)))},catmullRomPoint:function(a,b,c,d,e){var f=((-e+2)*e-1)*e*.5;var g=((3*e-5)*e*e+2)*.5;var h=((-3*e+4)*e+1)*e*.5;var i=(e-1)*e*e*.5;return[a[0]*f+b[0]*g+c[0]*h+d[0]*i,a[1]*f+b[1]*g+c[1]*h+d[1]*i]},catmullRomAngle:function(a,b,c,d,e){var f=.5*(c[0]-a[0]+2*e*(2*a[0]-5*b[0]+4*c[0]-d[0])+3*e*e*(3*b[0]+d[0]-a[0]-3*c[0]));var g=.5*(c[1]-a[1]+2*e*(2*a[1]-5*b[1]+4*c[1]-d[1])+3*e*e*(3*b[1]+d[1]-a[1]-3*c[1]));return Math.atan2(g,f)},catmullRomPointAngle:function(a,b,c,d,e){var f=this.catmullRomPoint(a,b,c,d,e);var a=this.catmullRomAngle(a,b,c,d,e);return{point:f,angle:a}},lineAngle:function(a,b){return Math.atan2(b[1]-a[1],b[0]-a[0])},quadraticAngle:function(a,b,c,d){var e=this.linePoint(a,b,d);var f=this.linePoint(b,c,d);return this.lineAngle(e,f)},cubicAngle:function(a,b,c,d,e){var f=this.quadraticPoint(a,b,c,e);var g=this.quadraticPoint(b,c,d,e);return this.lineAngle(f,g)},lineLength:function(a,b){var c=b[0]-a[0];var d=b[1]-a[1];return Math.sqrt(c*c+d*d)},squareLineLength:function(a,b){var c=b[0]-a[0];var d=b[1]-a[1];return c*c+d*d},quadraticLength:function(a,b,c,d){var e=this.linePoint(a,b,2/3);var f=this.linePoint(b,c,1/3);return this.cubicLength(a,e,f,c,d)},cubicLength:function(){var a=function(a){var b=[a.slice(0)];for(var c=1;c<4;c++){b[c]=[[],[],[],[]];for(var d=0;d<4-c;d++){b[c][d][0]=.5*(b[c-1][d][0]+b[c-1][d+1][0]);b[c][d][1]=.5*(b[c-1][d][1]+b[c-1][d+1][1])}}var e=[];var f=[];for(var d=0;d<4;d++){e[d]=b[d][0];f[d]=b[3-d][d]}return[e,f]};var b=function(c,d){var e=0;for(var f=0;f<3;f++){e+=Curves.lineLength(c[f],c[f+1])}var g=Curves.lineLength(c[0],c[3]);if(e-g>d){var h=a(c);e=b(h[0],d)+b(h[1],d)}return e};return function(a,c,d,e,f){if(!f)f=1;return b([a,c,d,e],f)}}(),quadraticLengthPointAngle:function(a,b,c,d,e){var f=this.linePoint(a,b,2/3);var g=this.linePoint(b,c,1/3);return this.cubicLengthPointAngle(a,f,g,c,e)},cubicLengthPointAngle:function(a,b,c,d,e,f){var g=this.cubicLength(a,b,c,d,f);var h=a;var i=a;var j=[];var k=0;var l=0;var m=e*g;var n=20;var o=1/n;for(var p=1;p<=n;p++){i=h;h=this.cubicPoint(a,b,c,d,o*p);k=l;l+=this.lineLength(i,h);if(l>=m){if(l==k)return{point:h,angle:this.lineAngle(a,b)};var q=l-m;var r=q/(l-k);return{point:this.linePoint(i,h,1-r),angle:this.cubicAngle(a,b,c,d,o*(p-r))}}}return{point:d.slice(0),angle:this.lineAngle(c,d)}}};Colors={hsl2rgb:function(a,b,c){var d,e,f;if(b==0){d=e=f=v}else{var g=c<.5?c*(1+b):c+b-c*b;var h=2*c-g;var i=a%360/360;var j=i+1/3;var k=i;var l=i-1/3;if(j<0)j++;if(j>1)j--;if(k<0)k++;if(k>1)k--;if(l<0)l++;if(l>1)l--;if(j<1/6)d=h+(g-h)*6*j;else if(j<1/2)d=g;else if(j<2/3)d=h+(g-h)*6*(2/3-j);else d=h;if(k<1/6)e=h+(g-h)*6*k;else if(k<1/2)e=g;else if(k<2/3)e=h+(g-h)*6*(2/3-k);else e=h;if(l<1/6)f=h+(g-h)*6*l;else if(l<1/2)f=g;else if(l<2/3)f=h+(g-h)*6*(2/3-l);else f=h}return[d,e,f]},hsv2rgb:function(a,b,c){var d,e,f;if(b==0){d=e=f=c}else{a=a%360/60;var g=Math.floor(a);var h=a-g;var i=c*(1-b);var j=c*(1-b*h);var k=c*(1-b*(1-h));switch(g){case 0:d=c;e=k;f=i;break;case 1:d=j;e=c;f=i;break;case 2:d=i;e=c;f=k;break;case 3:d=i;e=j;f=c;break;case 4:d=k;e=i;f=c;break;case 5:d=c;e=i;f=j;break}}return[d,e,f]},parseColorStyle:function(a,b){if(typeof a=="string"){return a}else if(a.compiled){return a.compiled}else if(a.isPattern){return a.compile(b)}else if(a.length==3){return"rgba("+a.map(Math.round).join(",")+", 1)"}else if(a.length==4){return"rgba("+Math.round(a[0])+","+Math.round(a[1])+","+Math.round(a[2])+","+a[3]+")"}else{throw"Bad style: "+a}}};CanvasSupport={DEVICE_SPACE:0,USER_SPACE:1,isPointInPathMode:null,supportsIsPointInPath:null,supportsCSSTransform:null,supportsCanvas:null,isCanvasSupported:function(){if(this.supportsCanvas==null){var a={};try{a=E("canvas")}catch(b){}this.supportsCanvas=a.getContext!=null}return this.supportsCanvas},isCSSTransformSupported:function(){if(this.supportsCSSTransform==null){var a=E("div");var b=a.style;var c=b.webkitTransform!=null||b.MozTransform!=null;this.supportsCSSTransform=c!=null}return this.supportsCSSTransform},getTestContext:function(){if(!this.testContext){var a=E.canvas(1,1);this.testContext=a.getContext("2d")}return this.testContext},getSupportsAudioTag:function(){var a=E("audio");return!!a.play},getSupportsSoundManager:function(){return window.soundManager&&soundManager.enabled},soundId:0,getSoundObject:function(){var a=null;if(this.getSupportsSoundManager()){a=this.getSoundManagerSoundObject()}return a},getAudioTagSoundObject:function(){var a="sound-"+this.soundId++;var b=E("audio",{id:a});b.load=function(a){this.src=a};b.addEventListener("canplaythrough",function(){if(this.onready)this.onready()},false);b.setVolume=function(a){this.volume=a};b.setPan=function(a){this.pan=a};return b},getSoundManagerSoundObject:function(){var a="sound-"+this.soundId++;var b={volume:100,pan:0,sid:a,load:function(a){return soundManager.load(this.sid,{url:a,autoPlay:false,volume:this.volume,pan:this.pan})},_onload:function(){if(this.onload)this.onload();if(this.onready)this.onready()},_onerror:function(){if(this.onerror)this.onerror()},_onfinish:function(){if(this.onfinish)this.onfinish()},play:function(){return soundManager.play(this.sid)},stop:function(){return soundManager.stop(this.sid)},pause:function(){return soundManager.togglePause(this.sid)},setVolume:function(a){this.volume=a*100;return soundManager.setVolume(this.sid,a*100)},setPan:function(a){this.pan=a*100;return soundManager.setPan(this.sid,a*100)}};soundManager.createSound(a,"null.mp3");b.sound=soundManager.getSoundById(a);b.sound.options.onfinish=b._onfinish.bind(b);b.sound.options.onload=b._onload.bind(b);b.sound.options.onerror=b._onerror.bind(b);return b},ContextSetterAugment:{setFillStyle:function(a){this.fillStyle=a},setStrokeStyle:function(a){this.strokeStyle=a},setGlobalAlpha:function(a){this.globalAlpha=a},setLineWidth:function(a){this.lineWidth=a},setLineCap:function(a){this.lineCap=a},setLineJoin:function(a){this.lineJoin=a},setMiterLimit:function(a){this.miterLimit=a},setGlobalCompositeOperation:function(a){this.globalCompositeOperation=a},setShadowColor:function(a){this.shadowColor=a},setShadowBlur:function(a){this.shadowBlur=a},setShadowOffsetX:function(a){this.shadowOffsetX=a},setShadowOffsetY:function(a){this.shadowOffsetY=a},setMozTextStyle:function(a){this.mozTextStyle=a},setFont:function(a){this.font=a},setTextAlign:function(a){this.textAlign=a},setTextBaseline:function(a){this.textBaseline=a}},ContextJSImplAugment:{identity:function(){CanvasSupport.setTransform(this,[1,0,0,1,0,0])}},augment:function(a){Object.conditionalExtend(a,this.ContextSetterAugment);Object.conditionalExtend(a,this.ContextJSImplAugment);return a},getContext:function(a,b){var c=a.getContext(b||"2d");this.augment(c);return c},tMatrixMultiply:function(a,b){var c=a[0]*b[0]+a[2]*b[1];var d=a[1]*b[0]+a[3]*b[1];var e=a[0]*b[2]+a[2]*b[3];var f=a[1]*b[2]+a[3]*b[3];var g=a[0]*b[4]+a[2]*b[5]+a[4];var h=a[1]*b[4]+a[3]*b[5]+a[5];a[0]=c;a[1]=d;a[2]=e;a[3]=f;a[4]=g;a[5]=h;return a},tMatrixMultiplyPoint:function(a,b,c){return[b*a[0]+c*a[2]+a[4],b*a[1]+c*a[3]+a[5]]},tInvertMatrix:function(a){var b=1/(a[0]*a[3]-a[1]*a[2]);return[a[3]*b,-a[1]*b,-a[2]*b,a[0]*b,b*(a[2]*a[5]-a[3]*a[4]),b*(a[1]*a[4]-a[0]*a[5])]},transform:function(a,b){if(a.transform)return a.transform.apply(a,b);a.translate(b[4],b[5]);if(Math.abs(b[1])<1e-6&&Math.abs(b[2])<1e-6){a.scale(b[0],b[3]);return}var c=this.svdTransform({xx:b[0],xy:b[2],yx:b[1],yy:b[3],dx:b[4],dy:b[5]});a.rotate(c.angle2);a.scale(c.sx,c.sy);a.rotate(c.angle1);return},brokenSvd:function(a){var b=[a[0],a[2],a[1],a[3],0,0];var c=[b[0]*a[0]+b[2]*a[1],b[1]*a[0]+b[3]*a[1],b[0]*a[2]+b[2]*a[3],b[1]*a[2]+b[3]*a[3],0,0];var d=1;var e=-(c[0]+c[3]);var f=-(c[1]*c[2])+c[0]*c[3];var g=Math.sqrt(e*e-4*d*f);var h=(-e+g)/(2*d);var i=(-e-g)/(2*d);if(h<i)var j=h,h=i,i=j;var k=Math.sqrt(h);var l=Math.sqrt(i);var m=[1/k,0,0,1/l,0,0];var n=(c[0]-h)/c[2];var o=Math.sqrt(1+n*n);var p=1/o;var q=n/o;var r=p;var s=-q;var t=[p,s,q,r,0,0];var u=a.slice(0);this.tMatrixMultiply(u,t);this.tMatrixMultiply(u,m);return[u,[k,0,0,l,0,0],[p,q,s,r,0,0]]},svdTransform:function(){var a={};a.Matrix2D=function(b){if(b){if(typeof b=="number"){this.xx=this.yy=b}else if(b instanceof Array){if(b.length>0){var c=a.normalize(b[0]);for(var d=1;d<b.length;++d){var e=c,f=a.normalize(b[d]);c=new a.Matrix2D;c.xx=e.xx*f.xx+e.xy*f.yx;c.xy=e.xx*f.xy+e.xy*f.yy;c.yx=e.yx*f.xx+e.yy*f.yx;c.yy=e.yx*f.xy+e.yy*f.yy;c.dx=e.xx*f.dx+e.xy*f.dy+e.dx;c.dy=e.yx*f.dx+e.yy*f.dy+e.dy}Object.extend(this,c)}}else{Object.extend(this,b)}}};a.normalize=function(b){return b instanceof a.Matrix2D?b:new a.Matrix2D(b)};a.multiply=function(b){var c=a.normalize(b);for(var d=1;d<arguments.length;++d){var e=c,f=a.normalize(arguments[d]);c=new a.Matrix2D;c.xx=e.xx*f.xx+e.xy*f.yx;c.xy=e.xx*f.xy+e.xy*f.yy;c.yx=e.yx*f.xx+e.yy*f.yx;c.yy=e.yx*f.xy+e.yy*f.yy;c.dx=e.xx*f.dx+e.xy*f.dy+e.dx;c.dy=e.yx*f.dx+e.yy*f.dy+e.dy}return c};a.invert=function(b){var c=a.normalize(b),d=c.xx*c.yy-c.xy*c.yx,c=new a.Matrix2D({xx:c.yy/d,xy:-c.xy/d,yx:-c.yx/d,yy:c.xx/d,dx:(c.xy*c.dy-c.yy*c.dx)/d,dy:(c.yx*c.dx-c.xx*c.dy)/d});return c};Object.extend(a.Matrix2D,{xx:1,xy:0,yx:0,yy:1,dx:0,dy:0});var b=function(a,b){return Math.abs(a-b)<=1e-6*(Math.abs(a)+Math.abs(b))};var c=function(a,b){if(!isFinite(a)){return b}else if(!isFinite(b)){return a}return(a+b)/2};var d=function(b){var c=new a.Matrix2D(b);return Object.extend(c,{dx:0,dy:0,xy:c.yx,yx:c.xy})};var e=function(a){return a.xx*a.yy<0||a.xy*a.yx>0?-1:1};var f=function(c){var d=a.normalize(c),e=-d.xx-d.yy,f=d.xx*d.yy-d.xy*d.yx,g=Math.sqrt(e*e-4*f),h=-(e+(e<0?-g:g))/2,i=f/h,j=d.xy/(h-d.xx),k=1,l=d.xy/(i-d.xx),n=1;if(b(h,i)){j=1,k=0,l=0,n=1}if(!isFinite(j)){j=1,k=(h-d.xx)/d.xy;if(!isFinite(k)){j=(h-d.yy)/d.yx,k=1;if(!isFinite(j)){j=1,k=d.yx/(h-d.yy)}}}if(!isFinite(l)){l=1,n=(i-d.xx)/d.xy;if(!isFinite(n)){l=(i-d.yy)/d.yx,n=1;if(!isFinite(l)){l=1,n=d.yx/(i-d.yy)}}}var o=Math.sqrt(j*j+k*k),p=Math.sqrt(l*l+n*n);if(isNaN(j/=o)){j=0}if(isNaN(k/=o)){k=0}if(isNaN(l/=p)){l=0}if(isNaN(n/=p)){n=0}return{value1:h,value2:i,vector1:{x:j,y:k},vector2:{x:l,y:n}}};var g=function(a,b){var d=e(a),f=b.angle1=(Math.atan2(a.yx,a.yy)+Math.atan2(-d*a.xy,d*a.xx))/2,g=Math.cos(f),h=Math.sin(f);b.sx=c(a.xx/g,-a.xy/h);b.sy=c(a.yy/g,a.yx/h);return b};var h=function(a,b){var d=e(a),f=b.angle2=(Math.atan2(d*a.yx,d*a.xx)+Math.atan2(-a.xy,a.yy))/2,g=Math.cos(f),h=Math.sin(f);b.sx=c(a.xx/g,a.yx/h);b.sy=c(a.yy/g,-a.xy/h);return b};return function(c){var e=a.normalize(c),i={dx:e.dx,dy:e.dy,sx:1,sy:1,angle1:0,angle2:0};if(b(e.xy,0)&&b(e.yx,0)){return Object.extend(i,{sx:e.xx,sy:e.yy})}if(b(e.xx*e.yx,-e.xy*e.yy)){return g(e,i)}if(b(e.xx*e.xy,-e.yx*e.yy)){return h(e,i)}var j=d(e),k=f([e,j]),l=f([j,e]),n=new a.Matrix2D({xx:k.vector1.x,xy:k.vector2.x,yx:k.vector1.y,yy:k.vector2.y}),o=new a.Matrix2D({xx:l.vector1.x,xy:l.vector1.y,yx:l.vector2.x,yy:l.vector2.y}),p=new a.Matrix2D([a.invert(n),e,a.invert(o)]);g(o,i);p.xx*=i.sx;p.yy*=i.sy;h(n,i);p.xx*=i.sx;p.yy*=i.sy;return Object.extend(i,{sx:p.xx,sy:p.yy})}}(),setTransform:function(a,b,c){if(a.setTransform)return a.setTransform.apply(a,b);this.transform(a,this.tInvertMatrix(c));this.transform(a,b)},skewX:function(a,b){return this.transform(a,this.tSkewXMatrix(b))},skewY:function(a,b){return this.transform(a,this.tSkewYMatrix(b))},tRotate:function(a,b){var c=Math.cos(b);var d=Math.sin(b);var e=a[0]*c+a[2]*d;var f=a[1]*c+a[3]*d;var g=a[0]*-d+a[2]*c;var h=a[1]*-d+a[3]*c;a[0]=e;a[1]=f;a[2]=g;a[3]=h;return a},tTranslate:function(a,b,c){a[4]+=a[0]*b+a[2]*c;a[5]+=a[1]*b+a[3]*c;return a},tScale:function(a,b,c){a[0]*=b;a[1]*=b;a[2]*=c;a[3]*=c;return a},tSkewX:function(a,b){return this.tMatrixMultiply(a,this.tSkewXMatrix(b))},tSkewY:function(a,b){return this.tMatrixMultiply(a,this.tSkewYMatrix(b))},tSkewXMatrix:function(a){return[1,0,Math.tan(a),1,0,0]},tSkewYMatrix:function(a){return[1,Math.tan(a),0,1,0,0]},tRotationMatrix:function(a){var b=Math.cos(a);var c=Math.sin(a);return[b,c,-c,b,0,0]},tTranslationMatrix:function(a,b){return[1,0,0,1,a,b]},tScalingMatrix:function(a,b){return[a,0,0,b,0,0]},getTextBackend:function(){if(this.textBackend==null)this.textBackend=this.detectTextBackend();return this.textBackend},detectTextBackend:function(){var a=this.getTestContext();if(a.fillText){return"HTML5"}else if(a.mozDrawText){return"MozText"}else if(a.drawString){return"DrawString"}return"NONE"},getSupportsPutImageData:function(){if(this.supportsPutImageData==null){var a=this.getTestContext();var b=a.putImageData;if(b){try{var c=a.getImageData(0,0,1,1);c[0]=255;c[1]=0;c[2]=255;c[3]=255;a.putImageData({width:1,height:1,data:c},0,0);var c=a.getImageData(0,0,1,1);b=[255,0,255,255].equals(c.data)}catch(d){b=false}}this.supportsPutImageData=b}return b},getSupportsIsPointInPath:function(){if(this.supportsIsPointInPath==null)this.supportsIsPointInPath=!!this.getTestContext().isPointInPath;return this.supportsIsPointInPath},getIsPointInPathMode:function(){if(this.isPointInPathMode==null)this.isPointInPathMode=this.detectIsPointInPathMode();return this.isPointInPathMode},detectIsPointInPathMode:function(){var a=this.getTestContext();var b;if(!a.isPointInPath)return this.USER_SPACE;a.save();a.translate(1,0);a.beginPath();a.rect(0,0,1,1);if(a.isPointInPath(.3,.3)){b=this.USER_SPACE}else{b=this.DEVICE_SPACE}a.restore();return b},isPointInPath:function(a,b,c,d,e){var f;if(!a.isPointInPath){if(e&&e.isPointInPath){var g=this.tMatrixMultiplyPoint(this.tInvertMatrix(d),b,c);return e.isPointInPath(g[0],g[1])}else{return false}}else{if(this.getIsPointInPathMode()==this.USER_SPACE){if(!a.setTransform){var g=this.tMatrixMultiplyPoint(this.tInvertMatrix(d),b,c);f=a.isPointInPath(g[0],g[1])}else{a.save();a.setTransform(1,0,0,1,0,0);f=a.isPointInPath(b,c);a.restore()}}else{f=a.isPointInPath(b,c)}return f}}};RecordingContext=Klass({objectId:0,commands:[],isMockObject:true,initialize:function(a){this.commands=a||[];Object.conditionalExtend(this,this.getMockContext())},getMockContext:function(){if(!RecordingContext.MockContext){var a=E.canvas(1,1);var b=CanvasSupport.getContext(a,"2d");var c={};for(var d in b){if(typeof b[d]=="function")c[d]=this.createRecordingFunction(d);else c[d]=b[d]}c.isPointInPath=null;c.transform=null;c.setTransform=null;RecordingContext.MockContext=c}return RecordingContext.MockContext},createRecordingFunction:function(a){if(a.search(/^set[A-Z]/)!=-1&&a!="setTransform"){var b=a.charAt(3).toLowerCase()+a.slice(4);return function(){this[b]=arguments[0];this.commands.push([a,$A(arguments)])}}else{return function(){this.commands.push([a,$A(arguments)])}}},clear:function(){this.commands=[]},getRecording:function(){return this.commands},serialize:function(a,b){return"("+{width:a,height:b,commands:this.getRecording()}.toSource()+")"},play:function(a){RecordingContext.play(a,this.getRecording())},createLinearGradient:function(){var a=this.objectId++;this.commands.push([a,"=","createLinearGradient",$A(arguments)]);return new MockGradient(this,a)},createRadialGradient:function(){var a=this.objectId++;this.commands.push([a,"=","createRadialGradient",$A(arguments)]);return new this.MockGradient(this,a)},createPattern:function(){var a=this.objectId++;this.commands.push([a,"=","createPattern",$A(arguments)]);return new this.MockGradient(this,a)},MockGradient:Klass({isMockObject:true,initialize:function(a,b){this.recorder=a;this.id=b},addColorStop:function(){this.recorder.commands.push([this.id,"addColorStop",$A(arguments)])},toSource:function(){return{id:this.id,isMockObject:true}.toSource()}})});RecordingContext.play=function(a,b){var c=[];for(var d=0;d<b.length;d++){var e=b[d];if(e.length==2){var f=e[1];if(f[0]&&f[0].isMockObject){a[e[0]](c[f[0].id])}else{a[e[0]].apply(a,e[1])}}else if(e.length==3){var g=c[e[0]];g[e[1]].apply(g,e[2])}else if(e.length==4){c[e[0]]=a[e[2]].apply(a,e[3])}else{throw"Malformed command: "+e.toString()}}};Transformable=Klass({needMatrixUpdate:true,transform:function(a){var b=this.absoluteMatrix;var c=this.x||this.y;var d=this.rotation;var e=this.scale!=null;var f=this.skewX;var g=this.skewY;var h=this.matrix;var i=this.transformList;if(this.needMatrixUpdate||!this.currentMatrix){if(!this.currentMatrix)this.currentMatrix=[1,0,0,1,0,0];if(this.parent)this.__copyMatrix(this.parent.currentMatrix);else this.__identityMatrix();if(b)this.__setMatrixMatrix(this.absoluteMatrix);if(c)this.__translateMatrix(this.x,this.y);if(d)this.__rotateMatrix(this.rotation);if(f)this.__skewXMatrix(this.skewX);if(g)this.__skewYMatrix(this.skewY);if(e)this.__scaleMatrix(this.scale);if(h)this.__matrixMatrix(this.matrix);if(i){for(var j=0;j<this.transformList.length;j++){var i=this.transformList[j];this["__"+i[0]+"Matrix"](i[1])}}this.needMatrixUpdate=false}if(!a)return;this.__setMatrix(a,this.currentMatrix)},distanceTo:function(a){return Curves.lineLength([this.x,this.y],[a.x,a.y])},angleTo:function(a){return Curves.lineAngle([this.x,this.y],[a.x,a.y])},__setMatrixMatrix:function(a){if(!this.previousMatrix)this.previousMatrix=[];var b=this.previousMatrix;var c=this.currentMatrix;b[0]=c[0];b[1]=c[1];b[2]=c[2];b[3]=c[3];b[4]=c[4];b[5]=c[5];b=this.currentMatrix;c=a;b[0]=c[0];b[1]=c[1];b[2]=c[2];b[3]=c[3];b[4]=c[4];b[5]=c[5]},__copyMatrix:function(a){var b=this.currentMatrix;var c=a;b[0]=c[0];b[1]=c[1];b[2]=c[2];b[3]=c[3];b[4]=c[4];b[5]=c[5]},__identityMatrix:function(){var a=this.currentMatrix;a[0]=1;a[1]=0;a[2]=0;a[3]=1;a[4]=0;a[5]=0},__translateMatrix:function(a,b){if(a.length){CanvasSupport.tTranslate(this.currentMatrix,a[0],a[1])}else{CanvasSupport.tTranslate(this.currentMatrix,a,b)}},__rotateMatrix:function(a){if(a.length){if(a[0]%Math.PI*2==0)return;if(a[1]||a[2]){CanvasSupport.tTranslate(this.currentMatrix,a[1],a[2]);CanvasSupport.tRotate(this.currentMatrix,a[0]);CanvasSupport.tTranslate(this.currentMatrix,-a[1],-a[2])}else{CanvasSupport.tRotate(this.currentMatrix,a[0])}}else{if(a%Math.PI*2==0)return;CanvasSupport.tRotate(this.currentMatrix,a)}},__skewXMatrix:function(a){if(a.length&&a[0])CanvasSupport.tSkewX(this.currentMatrix,a[0]);else CanvasSupport.tSkewX(this.currentMatrix,a)},__skewYMatrix:function(a){if(a.length&&a[0])CanvasSupport.tSkewY(this.currentMatrix,a[0]);else CanvasSupport.tSkewY(this.currentMatrix,a)},__scaleMatrix:function(a){if(a.length==2){if(a[0]==1&&a[1]==1)return;CanvasSupport.tScale(this.currentMatrix,a[0],a[1])}else if(a.length==3){if(a[0]==1||a[0].length&&a[0][0]==1&&a[0][1]==1)return;CanvasSupport.tTranslate(this.currentMatrix,a[1],a[2]);if(a[0].length){CanvasSupport.tScale(this.currentMatrix,a[0][0],a[0][1])}else{CanvasSupport.tScale(this.currentMatrix,a[0],a[0])}CanvasSupport.tTranslate(this.currentMatrix,-a[1],-a[2])}else if(a!=1){CanvasSupport.tScale(this.currentMatrix,a,a)}},__matrixMatrix:function(a){CanvasSupport.tMatrixMultiply(this.currentMatrix,a)},__setMatrix:function(a,b){CanvasSupport.setTransform(a,b,this.previousMatrix)},__translate:function(a,b,c){if(b.length!=null)a.translate(b[0],b[1]);else a.translate(b,c)},__rotate:function(a,b){if(b.length){if(b[1]||b[2]){if(b[0]%Math.PI*2==0)return;a.translate(b[1],b[2]);a.rotate(b[0]);a.translate(-b[1],-b[2])}else{a.rotate(b[0])}}else{a.rotate(b)}},__skewX:function(a,b){if(b.length&&b[0])CanvasSupport.skewX(a,b[0]);else CanvasSupport.skewX(a,b)},__skewY:function(a,b){if(b.length&&b[0])CanvasSupport.skewY(a,b[0]);else CanvasSupport.skewY(a,b)},__scale:function(a,b){if(b.length==2){a.scale(b[0],b[1])}else if(b.length==3){a.translate(b[1],b[2]);if(b[0].length){a.scale(b[0][0],b[0][1])}else{a.scale(b[0],b[0])}a.translate(-b[1],-b[2])}else{a.scale(b,b)}},__matrix:function(a,b){CanvasSupport.transform(a,b)}});Timeline=Klass({startTime:null,repeat:false,lastAction:0,initialize:function(a,b){this.repeat=a;this.keyframes=[]},addKeyframe:function(a,b,c){if(arguments.length==1)this.keyframes.push(a);else this.keyframes.push({time:a,target:b,tween:c})},appendKeyframe:function(a,b,c){this.lastAction+=a;return this.addKeyframe(this.lastAction,b,c)},evaluate:function(a,b,c){if(this.startTime==null)this.startTime=b;var d=b-this.startTime;if(this.keyframes.length>0){var e,f,g;for(var h=0;h<this.keyframes.length;h++){if(this.keyframes[h].time>d){e=h;break}}if(e!=null){f=this.keyframes[e-1];g=this.keyframes[e]}if(!g){if(!this.keyframes.atEnd){this.keyframes.atEnd=true;f=this.keyframes[this.keyframes.length-1];Object.extend(a,Object.clone(f.target));if(this.repeat)this.startTime=b;a.changed=true}}else if(f){this.keyframes.atEnd=false;var i=d-f.time;var j=g.time-f.time;var k=i/j;for(var l in g.target){if(f.target[l]!=null){a.tweenVariable(l,f.target[l],g.target[l],k,g.tween)}}}}}});Animatable=Klass({tweenFunctions:{linear:function(a){return a},set:function(a){return Math.floor(a)},discrete:function(a){return Math.floor(a)},sine:function(a){return.5-.5*Math.cos(a*Math.PI)},sproing:function(a){return(.5-.5*Math.cos(a*3.59261946538606))*1.05263157894737},square:function(a){return a*a},cube:function(a){return a*a*a},sqrt:function(a){return Math.sqrt(a)},curt:function(a){return Math.pow(a,-.333333333333)}},initialize:function(){this.lastAction=0;this.timeline=[];this.keyframes=[];this.pendingKeyframes=[];this.pendingTimelineEvents=[];this.timelines=[];this.animators=[];this.addFrameListener(this.updateTimelines);this.addFrameListener(this.updateKeyframes);this.addFrameListener(this.updateTimeline);this.addFrameListener(this.updateAnimators)},updateTimelines:function(a,b){for(var c=0;c<this.timelines.length;c++)this.timelines[c].evaluate(this,a,b)},addTimeline:function(a){this.timelines.push(a)},removeTimeline:function(a){this.timelines.deleteFirst(a)},updateKeyframes:function(a,b){this.addPendingKeyframes(a);if(this.keyframes.length>0){var c,d,e;for(var f=0;f<this.keyframes.length;f++){if(this.keyframes[f].time>a){c=f;break}}if(c!=null){d=this.keyframes[c-1];e=this.keyframes[c]}if(!e){if(!this.keyframes.atEnd){this.keyframes.atEnd=true;d=this.keyframes[this.keyframes.length-1];Object.extend(this,Object.clone(d.target));this.changed=true}}else if(d){this.keyframes.atEnd=false;var g=a-d.time;var h=e.time-d.time;var i=g/h;for(var j in e.target){if(d.target[j]!=null){this.tweenVariable(j,d.target[j],e.target[j],i,e.tween)}}}}},addPendingKeyframes:function(a){if(this.pendingKeyframes.length>0){while(this.pendingKeyframes.length>0){var b=this.pendingKeyframes.shift();if(b.time==null)b.time=b.relativeTime+a;this.keyframes.push(b)}this.keyframes.stableSort(function(a,b){return a.time-b.time})}},updateTimeline:function(a,b){this.addPendingTimelineEvents(a);while(this.timeline[0]&&this.timeline[0].startTime<=a){var c=this.timeline.shift();var d=true;if(typeof c.action=="function")d=c.action.call(this,a,b,c);else this.animators.push(c.action);if(c.repeatEvery!=null&&d!=false){if(c.repeatTimes!=null){if(c.repeatTimes<=0)continue;c.repeatTimes--}c.startTime+=c.repeatEvery;this.addTimelineEvent(c)}this.changed=true}},addPendingTimelineEvents:function(a){if(this.pendingTimelineEvents.length>0){while(this.pendingTimelineEvents.length>0){var b=this.pendingTimelineEvents.shift();if(!b.startTime)b.startTime=b.relativeStartTime+a;this.timeline.push(b)}this.timeline.stableSort(function(a,b){return a.startTime-b.startTime})}},addTimelineEvent:function(a){this.pendingTimelineEvents.push(a)},updateAnimators:function(a,b){for(var c=0;c<this.animators.length;c++){var d=this.animators[c];if(!d.startTime)d.startTime=a;var e=a-d.startTime;var f=e/d.duration;var g=false;if(f>=1){if(!d.repeat){f=1;g=true}else{if(d.repeat!==true)d.repeat=Math.max(0,d.repeat-1);if(d.accumulate){d.startValue=Object.clone(d.endValue);d.endValue=Object.sum(d.difference,d.endValue)}if(d.repeat==0){g=true;f=1}else{d.startTime=a;f=f%1}}}else if(d.repeat&&d.repeat!==true&&d.repeat<=f){g=true;f=d.repeat}this.tweenVariable(d.variable,d.startValue,d.endValue,f,d.tween);if(g){this.animators.splice(c,1);c--}}},tweenVariable:function(a,b,c,d,e){if(typeof e!="function"){e=this.tweenFunctions[e]||this.tweenFunctions.linear}var f=e(d);if(typeof a!="function"){if(b instanceof Array){for(var g=0;g<b.length;g++){this[a][g]=b[g]+f*(c[g]-b[g])}}else{this[a]=b+f*(c-b)}}else{a.call(this,f,b,c)}this.changed=true},animate:function(a,b,c,d,e,f){var b=Object.clone(b);var c=Object.clone(c);if(!f)f={};if(f.additive){var g=Object.sub(c,b);b=Object.sum(b,this[a]);c=Object.sum(c,this[a])}if(typeof a!="function")this[a]=Object.clone(b);var h={id:Animatable.uid++,variable:a,startValue:b,endValue:c,difference:g,duration:d,tween:e,repeat:f.repeat,additive:f.additive,accumulate:f.accumulate,pingpong:f.pingpong};this.animators.push(h);return h},removeAnimator:function(a){this.animators.deleteFirst(a)},animateTo:function(a,b,c,d,e){return this.animate(a,this[a],b,c,d,e)},animateFrom:function(a,b,c,d,e){return this.animate(a,b,this[a],c,d,e)},animateFactor:function(a,b,c,d,e,f){var g;if(b instanceof Array){g=[];for(var h=0;h<b.length;h++){g[h]=b[h]*c}}else{g=b*c}return this.animate(a,b,g,d,e,f)},animateToFactor:function(a,b,c,d,e){var f=this[a];return this.animateFactor(a,f,b,c,d,e)},addKeyframe:function(a,b,c){var d={relativeTime:a,target:b,tween:c};this.pendingKeyframes.push(d)},addKeyframeAt:function(a,b,c){var d={time:a,target:b,tween:c};this.pendingKeyframes.push(d)},appendKeyframe:function(a,b,c){this.lastAction+=a;return this.addKeyframe(this.lastAction,b,c)},every:function(a,b,c){var d={action:b,relativeStartTime:c?a:0,repeatEvery:a};this.addTimelineEvent(d);return d},at:function(a,b){var c={action:b,startTime:a};this.addTimelineEvent(c);return c},after:function(a,b){var c={action:b,relativeStartTime:a};this.addTimelineEvent(c);return c},afterFrame:function(a,b){var c=0;var d;d=function(e,f){if(c>=a){b.call(this);this.removeFrameListener(d)}c++};this.addFrameListener(d);return d},everyFrame:function(a,b,c){var d=c?0:a;var e;e=function(c,f){if(d>=a){if(b.call(this)==false)this.removeFrameListener(e);d=0}d++};this.addFrameListener(e);return e}});Animatable.uid=0;CanvasNode=Klass(Animatable,Transformable,{OBJECTBOUNDINGBOX:"objectBoundingBox",visible:true,drawable:true,display:null,visibility:null,catchMouse:true,pickable:false,underCursor:false,zIndex:0,x:0,y:0,scale:1,rotation:0,matrix:null,absoluteMatrix:null,transformList:null,fill:null,stroke:null,strokeWidth:null,lineCap:null,lineJoin:null,miterLimit:null,absoluteOpacity:null,opacity:null,fillOpacity:null,strokeOpacity:null,compositeOperation:null,shadowColor:null,shadowBlur:null,shadowOffsetX:null,shadowOffsetY:null,font:null,textAlign:null,textBaseline:null,cursor:null,changed:true,tagName:"g",getNextSibling:function(){if(this.parentNode)return this.parentNode.childNodes[this.parentNode.childNodes.indexOf(this)+1];return null},getPreviousSibling:function(){if(this.parentNode)return this.parentNode.childNodes[this.parentNode.childNodes.indexOf(this)-1];return null},initialize:function(a){this.root=this;this.currentMatrix=[1,0,0,1,0,0];this.previousMatrix=[1,0,0,1,0,0];this.needMatrixUpdate=true;this.childNodes=[];this.frameListeners=[];this.eventListeners={};Animatable.initialize.call(this);if(a)Object.extend(this,a)},clone:function(){var a=Object.clone(this);a.parent=a.root=null;for(var b in this){if(typeof this[b]=="object")a[b]=Object.clone(this[b])}a.parent=a.root=null;a.childNodes=[];a.setRoot(null);for(var b=0;b<this.childNodes.length;b++){var c=this.childNodes[b].clone();a.append(c)}return a},cloneNode:function(){return this.clone()},getElementById:function(a){if(this.id==a)return this;for(var b=0;b<this.childNodes.length;b++){var c=this.childNodes[b].getElementById(a);if(c)return c}return null},$:function(a){return this.getElementById(a)},appendChild:function(){return this.append.apply(this,arguments)},append:function(a){var b=$A(arguments);for(var c=0;c<b.length;c++){if(b[c].parent)b[c].removeSelf();this.childNodes.push(b[c]);b[c].parent=b[c].parentNode=this;b[c].setRoot(this.root)}this.changed=true},removeAllChildren:function(){this.remove.apply(this,this.childNodes)},removeChild:function(){return this.remove.apply(this,arguments)},remove:function(a){var b=arguments;for(var c=0;c<b.length;c++){this.childNodes.deleteFirst(b[c]);delete b[c].parent;delete b[c].parentNode;b[c].setRoot(null)}this.changed=true},removeSelf:function(){if(this.parentNode){this.parentNode.remove(this)}},contains:function(a){while(a){if(a==this)return true;a=a.parentNode}return false},setRoot:function(a){if(!a)a=this;this.dispatchEvent({type:"rootChanged",canvasTarget:this,relatedTarget:a});this.root=a;for(var b=0;b<this.childNodes.length;b++)this.childNodes[b].setRoot(a)},addFrameListener:function(a){this.frameListeners.push(a)},removeFrameListener:function(a){this.frameListeners.deleteFirst(a)},addEventListener:function(a,b,c){if(!this.eventListeners[a])this.eventListeners[a]={capture:[],bubble:[]};this.eventListeners[a][c?"capture":"bubble"].push(b)},when:function(a,b,c){this.addEventListener(a,b,c||false)},removeEventListener:function(a,b,c){if(!this.eventListeners[a])return;this.eventListeners[a][c?"capture":"bubble"].deleteFirst(b);if(this.eventListeners[a].capture.length==0&&this.eventListeners[a].bubble.length==0)delete this.eventListeners[a]},dispatchEvent:function(a){var b=a.type;if(!a.canvasTarget){if(b.search(/^(key|text)/i)==0){a.canvasTarget=this.root.focused||this.root.target}else{a.canvasTarget=this.root.target}if(!a.canvasTarget)a.canvasTarget=this}var c=[];var d=a.canvasTarget;while(d&&d!=this){c.push(d);d=d.parent}c.push(this);a.canvasPhase="capture";for(var e=c.length-1;e>=0;e--)if(!c[e].handleEvent(a))return false;a.canvasPhase="bubble";for(var e=0;e<c.length;e++)if(!c[e].handleEvent(a))return false;return true},broadcastEvent:function(a){var b=a.type;a.canvasPhase="capture";if(!this.handleEvent(a))return false;for(var c=0;c<this.childNodes.length;c++)if(!this.childNodes[c].broadcastEvent(a))return false;a.canvasPhase="bubble";if(!this.handleEvent(a))return false;return true},handleEvent:function(a){var b=a.type;var c=a.canvasPhase;if(this.cursor&&c=="capture")a.cursor=this.cursor;var d=this.eventListeners[b];d=d&&d[c];if(d){for(var e=0;e<d.length;e++){var f=d[e].call(this,a);if(f==false||a.stopped){if(!a.stopped)a.stopPropagation();a.stopped=true;return false}}}return true},handleUpdate:function(a,b){this.update(a,b);this.willBeDrawn=(!this.parent||this.parent.willBeDrawn)&&(this.display?this.display!="none":this.visible);for(var c=0;c<this.childNodes.length;c++)this.childNodes[c].handleUpdate(a,b);if(this.parent&&this.changed){this.parent.changed=this.changed;this.changed=false}this.needMatrixUpdate=true},update:function(a,b){var c=this.frameListeners.slice(0);for(var d=0;d<c.length;d++){if(this.frameListeners.includes(c[d]))c[d].apply(this,arguments)}},handlePick:function(a){if(this.display)this.visible=this.display!="none";if(this.visibility)this.drawable=this.visibility!="hidden";this.underCursor=false;if(this.visible&&this.catchMouse&&this.root.absoluteMouseX!=null){a.save();this.transform(a,true);if(this.pickable&&this.drawable){if(a.isPointInPath){a.beginPath();if(this.drawPickingPath)this.drawPickingPath(a)}this.underCursor=CanvasSupport.isPointInPath(this.drawPickingPath?a:false,this.root.mouseX,this.root.mouseY,this.currentMatrix,this);if(this.underCursor)this.root.target=this}else{this.underCursor=false}var b=this.__getChildrenCopy();this.__zSort(b);for(var c=0;c<b.length;c++){b[c].handlePick(a);if(!this.underCursor)this.underCursor=b[c].underCursor}a.restore()}else{var b=this.__getChildrenCopy();while(b.length>0){var d=b.pop();if(d.underCursor){d.underCursor=false;Array.prototype.push.apply(b,d.childNodes)}}}},__zSort:function(a){a.stableSort(function(a,b){return a.zIndex-b.zIndex})},__getChildrenCopy:function(){if(this.__childNodesCopy){while(this.__childNodesCopy.length>this.childNodes.length)this.__childNodesCopy.pop();for(var a=0;a<this.childNodes.length;a++)this.__childNodesCopy[a]=this.childNodes[a]}else{this.__childNodesCopy=this.childNodes.slice(0)}return this.__childNodesCopy},isPointInPath:false,handleDraw:function(a){if(this.display)this.visible=this.display!="none";if(this.visibility)this.drawable=this.visibility!="hidden";if(!this.visible)return;a.save();var b=a.fontFamily;var c=a.fontSize;var d=a.fillOn;var e=a.strokeOn;if(this.fontFamily)a.fontFamily=this.fontFamily;if(this.fontSize)a.fontSize=this.fontSize;this.transform(a);if(this.clipPath){a.beginPath();if(this.clipPath.units==this.OBJECTBOUNDINGBOX){var f=this.getSubtreeBoundingBox(true);a.save();a.translate(f[0],f[1]);a.scale(f[2],f[3]);this.clipPath.createSubtreePath(a,true);a.restore();a.clip()}else{this.clipPath.createSubtreePath(a,true);a.clip()}}if(this.drawable&&this.draw)this.draw(a);var g=this.__getChildrenCopy();this.__zSort(g);for(var h=0;h<g.length;h++){g[h].handleDraw(a)}a.fontFamily=b;a.fontSize=c;a.fillOn=d;a.strokeOn=e;a.restore()},transform:function(a,b){Transformable.prototype.transform.call(this,a);if(b)return;if(this.fill!=null){if(!this.fill||this.fill=="none"){a.fillOn=false}else{a.fillOn=true;if(this.fill!=true){var c=Colors.parseColorStyle(this.fill,a);a.setFillStyle(c)}}}if(this.stroke!=null){if(!this.stroke||this.stroke=="none"){a.strokeOn=false}else{a.strokeOn=true;if(this.stroke!=true)a.setStrokeStyle(Colors.parseColorStyle(this.stroke,a))}}if(this.strokeWidth!=null)a.setLineWidth(this.strokeWidth);if(this.lineCap!=null)a.setLineCap(this.lineCap);if(this.lineJoin!=null)a.setLineJoin(this.lineJoin);if(this.miterLimit!=null)a.setMiterLimit(this.miterLimit);if(this.absoluteOpacity!=null)a.setGlobalAlpha(this.absoluteOpacity);if(this.opacity!=null)a.setGlobalAlpha(a.globalAlpha*this.opacity);if(this.compositeOperation!=null)a.setGlobalCompositeOperation(this.compositeOperation);if(this.shadowColor!=null)a.setShadowColor(Colors.parseColorStyle(this.shadowColor,a));if(this.shadowBlur!=null)a.setShadowBlur(this.shadowBlur);if(this.shadowOffsetX!=null)a.setShadowOffsetX(this.shadowOffsetX);if(this.shadowOffsetY!=null)a.setShadowOffsetY(this.shadowOffsetY);if(this.textAlign!=null)a.setTextAlign(this.textAlign);if(this.textBaseline!=null)a.setTextBaseline(this.textBaseline);if(this.font!=null)a.setFont(this.font)},drawPickingPath:false,draw:false,createSubtreePath:function(a,b){a.save();if(!b)this.transform(a,true);for(var c=0;c<this.childNodes.length;c++)this.childNodes[c].createSubtreePath(a);a.restore()},getSubtreeBoundingBox:function(a){if(a){var b=this.parent;this.parent=null;this.needMatrixUpdate=true}var c=this.getAxisAlignedBoundingBox();for(var d=0;d<this.childNodes.length;d++){var e=this.childNodes[d].getSubtreeBoundingBox();if(!c){c=e}else if(e){this.mergeBoundingBoxes(c,e)}}if(a){this.parent=b;this.needMatrixUpdate=true}return c},mergeBoundingBoxes:function(a,b){if(a[0]>b[0])a[0]=b[0];if(a[1]>b[1])a[1]=b[1];if(a[2]+a[0]<b[2]+b[0])a[2]=b[2]+b[0]-a[0];if(a[3]+a[1]<b[3]+b[1])a[3]=b[3]+b[1]-a[1]},getAxisAlignedBoundingBox:function(){this.transform(null,true);if(!this.getBoundingBox)return null;var a=this.getBoundingBox();var b=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,a[0],a[1]);var c=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,a[0]+a[2],a[1]+a[3]);var d=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,a[0],a[1]+a[3]);var e=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,a[0]+a[2],a[1]);var f=Math.min(b[0],c[0],d[0],e[0]);var g=Math.max(b[0],c[0],d[0],e[0]);var h=Math.min(b[1],c[1],d[1],e[1]);var i=Math.max(b[1],c[1],d[1],e[1]);return[f,h,g-f,i-h]},makeDraggable:function(){this.addEventListener("dragstart",function(a){this.dragStartPosition={x:this.x,y:this.y};a.stopPropagation();a.preventDefault();return false},false);this.addEventListener("drag",function(a){this.x=this.dragStartPosition.x+this.root.dragX/this.parent.currentMatrix[0];this.y=this.dragStartPosition.y+this.root.dragY/this.parent.currentMatrix[3];a.stopPropagation();a.preventDefault();return false},false)}});Canvas=Klass(CanvasNode,{clear:true,frameLoop:false,recording:false,opacity:1,frame:0,elapsed:0,frameDuration:30,speed:1,time:0,fps:0,currentRealFps:0,currentFps:0,fpsFrames:30,startTime:0,realFps:0,fixedTimestep:false,playOnlyWhenFocused:true,isPlaying:true,redrawOnlyWhenChanged:false,changed:true,drawBoundingBoxes:false,cursor:"default",mouseDown:false,mouseEvents:[],absoluteMouseX:null,absoluteMouseY:null,mouseX:null,mouseY:null,elementNodeZIndexCounter:0,initialize:function(a,b){if(arguments.length>2){var c=arguments[0];var d=arguments[1];var e=arguments[2];var b=arguments[3];var a=E.canvas(d,e);var f=E("div",a,{style:{overflow:"hidden",width:d+"px",height:e+"px",position:"relative"}});this.canvasContainer=f;if(c)c.appendChild(f)}CanvasNode.initialize.call(this,b);this.mouseEventStack=[];this.canvas=a;a.canvas=this;this.width=this.canvas.width;this.height=this.canvas.height;var g=this;this.frameHandler=function(){g.onFrame()};this.canvas.addEventListener("DOMNodeInserted",function(a){if(a.target==this)g.addEventListeners()},false);this.canvas.addEventListener("DOMNodeRemoved",function(a){if(a.target==this)g.removeEventListeners()},false);if(this.canvas.parentNode)this.addEventListeners();this.startTime=(new Date).getTime();if(this.isPlaying)this.play()},removeEventListeners:function(){},addEventListeners:function(){var a=this;this.canvas.parentNode.addMouseEvent=function(b){var c=Mouse.getRelativeCoords(this,b);a.absoluteMouseX=c.x;a.absoluteMouseY=c.y;var d=document.defaultView.getComputedStyle(a.canvas,"");var e=parseFloat(d.getPropertyValue("width"));var f=parseFloat(d.getPropertyValue("height"));a.mouseX=a.absoluteMouseX*(e/a.canvas.width);a.mouseY=a.absoluteMouseY*(f/a.canvas.height);a.addMouseEvent(a.mouseX,a.mouseY,a.mouseDown)};this.canvas.parentNode.contains=this.contains;this.canvas.parentNode.addEventListener("mousedown",function(b){a.mouseDown=true;if(a.keyTarget!=a.target){if(a.keyTarget)a.dispatchEvent({type:"blur",canvasTarget:a.keyTarget});a.keyTarget=a.target;if(a.keyTarget)a.dispatchEvent({type:"focus",canvasTarget:a.keyTarget})}this.addMouseEvent(b)},true);this.canvas.parentNode.addEventListener("mouseup",function(b){this.addMouseEvent(b);a.mouseDown=false},true);this.canvas.parentNode.addEventListener("mousemove",function(b){this.addMouseEvent(b);if(a.prevClientX==null){a.prevClientX=b.clientX;a.prevClientY=b.clientY}if(a.dragTarget){var c=document.createEvent("MouseEvents");c.initMouseEvent("drag",true,true,window,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget);c.canvasTarget=a.dragTarget;c.dx=b.clientX-a.prevClientX;c.dy=b.clientY-a.prevClientY;a.dragX+=c.dx;a.dragY+=c.dy;a.dispatchEvent(c)}if(!a.mouseDown){if(a.dragTarget){var c=document.createEvent("MouseEvents");c.initMouseEvent("dragend",true,true,window,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget);c.canvasTarget=a.dragTarget;a.dispatchEvent(c);a.dragX=a.dragY=0;a.dragTarget=false}}else if(!a.dragTarget&&a.target){a.dragTarget=a.target;var c=document.createEvent("MouseEvents");c.initMouseEvent("dragstart",true,true,window,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget);c.canvasTarget=a.dragTarget;a.dragStartX=b.clientX;a.dragStartY=b.clientY;a.dragX=a.dragY=0;a.dispatchEvent(c)}a.prevClientX=b.clientX;a.prevClientY=b.clientY},true);this.canvas.parentNode.addEventListener("mouseout",function(b){if(!CanvasNode.contains.call(this,b.relatedTarget))a.absoluteMouseX=a.absoluteMouseY=a.mouseX=a.mouseY=null},true);var b=this.dispatchEvent.bind(this);var c=["mousemove","mouseover","mouseout","click","dblclick","mousedown","mouseup","keypress","keydown","keyup","DOMMouseScroll","mousewheel","mousemultiwheel","textInput","focus","blur"];for(var d=0;d<c.length;d++){this.canvas.parentNode.addEventListener(c[d],b,false)}this.keys={};this.windowEventListeners={keydown:function(b){if(a.keyTarget){a.updateKeys(b);b.canvasTarget=a.keyTarget;a.dispatchEvent(b)}},keyup:function(b){if(a.keyTarget){a.updateKeys(b);b.canvasTarget=a.keyTarget;a.dispatchEvent(b)}},keypress:function(b){if(a.keyTarget){b.canvasTarget=a.keyTarget;a.dispatchEvent(b)}},blur:function(b){a.absoluteMouseX=a.absoluteMouseY=null;if(a.playOnlyWhenFocused&&a.isPlaying){a.stop();a.__blurStop=true}},focus:function(b){if(a.__blurStop&&!a.isPlaying)a.play()},mouseup:function(b){a.mouseDown=false;if(a.dragTarget){var c=document.createEvent("MouseEvents");c.initMouseEvent("dragend",true,true,window,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget);c.canvasTarget=a.dragTarget;a.dispatchEvent(c);a.dragTarget=false}if(!a.canvas.parentNode.contains(b.target)){var d=a.dispatchEvent(b);if(a.keyTarget){a.dispatchEvent({type:"blur",canvasTarget:a.keyTarget});a.keyTarget=null}return d}},mousemove:function(b){if(a.__blurStop&&!a.isPlaying)a.play();if(!a.canvas.parentNode.contains(b.target)&&a.mouseDown)return a.dispatchEvent(b)}};this.canvas.parentNode.addEventListener("DOMNodeRemoved",function(b){if(b.target==this)a.removeWindowEventListeners()},false);this.canvas.parentNode.addEventListener("DOMNodeInserted",function(b){if(b.target==this)a.addWindowEventListeners()},false);if(this.canvas.parentNode.parentNode)this.addWindowEventListeners()},updateKeys:function(a){this.keys.shift=a.shiftKey;this.keys.ctrl=a.ctrlKey;this.keys.alt=a.altKey;this.keys.meta=a.metaKey;var b=a.type=="keydown";switch(a.keyCode){case 37:this.keys.left=b;break;case 38:this.keys.up=b;break;case 39:this.keys.right=b;break;case 40:this.keys.down=b;break;case 32:this.keys.space=b;break;case 13:this.keys.enter=b;break;case 9:this.keys.tab=b;break;case 8:this.keys.backspace=b;break;case 16:this.keys.shift=b;break;case 17:this.keys.ctrl=b;break;case 18:this.keys.alt=b;break}this.keys[a.keyCode]=b},addWindowEventListeners:function(){for(var a in this.windowEventListeners)window.addEventListener(a,this.windowEventListeners[a],false)},removeWindowEventListeners:function(){for(var a in this.windowEventListeners)window.removeEventListener(a,this.windowEventListeners[a],false)},addMouseEvent:function(a,b,c){var d=this.allocMouseEvent();d[0]=a;d[1]=b;d[2]=c;this.mouseEvents.push(d)},allocMouseEvent:function(){if(this.mouseEventStack.length>0){return this.mouseEventStack.pop()}else{return[null,null,null]}},freeMouseEvent:function(a){this.mouseEventStack.push(a);if(this.mouseEventStack.length>100)this.mouseEventStack.splice(0,this.mouseEventStack.length)},clearMouseEvents:function(){while(this.mouseEvents.length>0)this.freeMouseEvent(this.mouseEvents.pop())},play:function(){this.stop();this.realTime=(new Date).getTime();this.frameLoop=setInterval(this.frameHandler,this.frameDuration);this.isPlaying=true},stop:function(){this.__blurStop=false;if(this.frameLoop){clearInterval(this.frameLoop);this.frameLoop=false}this.isPlaying=false},dispatchEvent:function(a){var b=CanvasNode.prototype.dispatchEvent.call(this,a);if(a.cursor){if(this.canvas.style.cursor!=a.cursor)this.canvas.style.cursor=a.cursor}else{if(this.canvas.style.cursor!=this.cursor)this.canvas.style.cursor=this.cursor}return b},onFrame:function(a,b){this.elementNodeZIndexCounter=0;var c=this.getContext();try{var d=(new Date).getTime();this.currentRealElapsed=d-this.realTime;this.currentRealFps=1e3/this.currentRealElapsed;var e=this.frameDuration*this.speed;if(!this.fixedTimestep)e=this.currentRealElapsed*this.speed;this.realTime=d;if(a!=null){this.time=a;if(b)e=b}else{this.time+=e}this.previousTarget=this.target;this.target=null;if(this.catchMouse)this.handlePick(c);if(this.previousTarget!=this.target){if(this.previousTarget){var f=document.createEvent("MouseEvents");f.initMouseEvent("mouseout",true,true,window,0,0,0,0,0,false,false,false,false,0,null);f.canvasTarget=this.previousTarget;this.dispatchEvent(f)}if(this.target){var f=document.createEvent("MouseEvents");f.initMouseEvent("mouseover",true,true,window,0,0,0,0,0,false,false,false,false,0,null);f.canvasTarget=this.target;this.dispatchEvent(f)}}this.handleUpdate(this.time,e);this.clearMouseEvents();if(!this.redrawOnlyWhenChanged||this.changed){try{this.handleDraw(c)}catch(g){console.log(g);throw g}this.changed=false}this.currentElapsed=(new Date).getTime()-this.realTime;this.elapsed+=this.currentElapsed;this.currentFps=1e3/this.currentElapsed;this.frame++;if(this.frame%this.fpsFrames==0){this.fps=this.fpsFrames*1e3/this.elapsed;this.realFps=this.fpsFrames*1e3/((new Date).getTime()-this.startTime);this.elapsed=0;this.startTime=(new Date).getTime()}}catch(g){if(c){try{for(var h=0;h<1e3;h++)c.restore()}catch(i){}}delete this.context;throw g}},getContext:function(){if(this.recording)return this.getRecordingContext();else if(this.useMockContext)return this.getMockContext();else return this.get2DContext()},get2DContext:function(){if(!this.context){var a=CanvasSupport.getContext(this.canvas,"2d");this.context=a}return this.context},getMockContext:function(){if(!this.fakeContext){var a=this.get2DContext();this.fakeContext={};var b=function(){return this};for(var c in a){if(typeof a[c]=="function")this.fakeContext[c]=b;else this.fakeContext[c]=a[c]}this.fakeContext.isMockObject=true;this.fakeContext.addColorStop=b}return this.fakeContext},getRecordingContext:function(){if(!this.recordingContext)this.recordingContext=new RecordingContext;return this.recordingContext},drawPickingPath:function(a){a.rect(0,0,this.canvas.width,this.canvas.height)},isPointInPath:function(a,b){return a>=0&&a<=this.canvas.width&&b>=0&&b<=this.canvas.height},draw:function(a){a.setGlobalAlpha(this.opacity);if(this.clear){if(a.fillOn){a.beginPath();a.rect(0,0,this.canvas.width,this.canvas.height);a.fill()}else{a.clearRect(0,0,this.canvas.width,this.canvas.height)}}a.fillStyle="black";a.strokeStyle="black";a.fillOn=false;a.strokeOn=false}});LinkNode=Klass(CanvasNode,{href:null,target:"_self",cursor:"pointer",initialize:function(a,b,c){this.href=a;if(b)this.target=b;CanvasNode.initialize.call(this,c);this.setupLinkEventListeners()},setupLinkEventListeners:function(){this.addEventListener("click",function(a){if(a.button==Mouse.RIGHT)return;var b=this.target;if((a.ctrlKey||a.button==Mouse.MIDDLE)&&b=="_self")b="_blank";window.open(this.href,b)},false)}});AudioNode=Klass(CanvasNode,{ready:false,autoPlay:false,playing:false,paused:false,pan:0,volume:1,loop:false,transformSound:false,initialize:function(a,b){CanvasNode.initialize.call(this,b);this.filename=a;this.when("load",this._autoPlaySound);this.loadSound()},loadSound:function(){this.sound=CanvasSupport.getSoundObject();if(!this.sound)return;var a=this;this.sound.onready=function(){a.ready=true;a.root.dispatchEvent({type:"ready",canvasTarget:a})};this.sound.onload=function(){a.loaded=true;a.root.dispatchEvent({type:"load",canvasTarget:a})};this.sound.onerror=function(){a.root.dispatchEvent({type:"error",canvasTarget:a})};this.sound.onfinish=function(){if(a.loop)a.play();else a.stop()};this.sound.load(this.filename)},play:function(){this.playing=true;this.needPlayUpdate=true},stop:function(){this.playing=false;this.needPlayUpdate=true},pause:function(){if(this.needPauseUpdate){this.needPauseUpdate=false;return}this.paused=!this.paused;this.needPauseUpdate=true},setVolume:function(a){this.volume=a;this.needStatusUpdate=true},setPan:function(a){this.pan=a;this.needStatusUpdate=true},handleUpdate:function(){CanvasNode.handleUpdate.apply(this,arguments);if(this.willBeDrawn){this.transform(null,true);if(!this.sound)this.loadSound();if(this.ready){if(this.transformSound){var a=this.currentMatrix[4];var b=this.currentMatrix[5];var c=this.currentMatrix[2];var d=this.currentMatrix[3];var e=this.currentMatrix[0];var f=this.currentMatrix[1];var g=this.root.width*.5;var h=Math.sqrt(c*c+d*d);var i=Math.sqrt(e*e+f*f);this.setVolume(h);this.setPan((a-g)/g)}if(this.needPauseUpdate){this.needPauseUpdate=false;this._pauseSound()}if(this.needPlayUpdate){this.needPlayUpdate=false;if(this.playing)this._playSound();else this._stopSound()}if(this.needStatusUpdate){this._setSoundVolume();this._setSoundPan()}}}},_autoPlaySound:function(){if(this.autoPlay)this.play()},_setSoundVolume:function(){this.sound.setVolume(this.volume)},_setSoundPan:function(){this.sound.setPan(this.pan)},_playSound:function(){if(this.sound.play()==false)return this.playing=false;this.root.dispatchEvent({type:"play",canvasTarget:this})},_stopSound:function(){this.sound.stop();this.root.dispatchEvent({type:"stop",canvasTarget:this})},_pauseSound:function(){this.sound.pause();this.root.dispatchEvent({type:this.paused?"pause":"play",canvasTarget:this})}});ElementNode=Klass(CanvasNode,{noScaling:false,noAlpha:false,inherit:"inherit",align:null,valign:null,xOffset:0,yOffset:0,initialize:function(a,b){CanvasNode.initialize.call(this,b);this.content=a;this.element=E("div",a);this.element.style.MozTransformOrigin=this.element.style.webkitTransformOrigin="0 0";this.element.style.position="absolute"},clone:function(){var a=CanvasNode.prototype.clone.call(this);if(this.content&&this.content.cloneNode)a.content=this.content.cloneNode(true);a.element=E("div",a.content);a.element.style.position="absolute";a.element.style.MozTransformOrigin=a.element.style.webkitTransformOrigin="0 0";return a},setRoot:function(a){CanvasNode.setRoot.call(this,a);if(this.element&&this.element.parentNode&&this.element.parentNode.removeChild)this.element.parentNode.removeChild(this.element)},handleUpdate:function(a,b){CanvasNode.handleUpdate.call(this,a,b);if(!this.willBeDrawn||!this.visible||this.display=="none"||this.visibility=="hidden"||!this.drawable){if(this.element.style.display!="none")this.element.style.display="none"}else if(this.element.style.display=="none"){this.element.style.display="block"}},addEventListener:function(a,b,c){var d=this;var e=function(){b.apply(d,arguments)};return this.element.addEventListener(a,e,c||false)},removeEventListener:function(a,b,c){var d=this;var e=function(){b.apply(d,arguments)};return this.element.removeEventListener(a,e,c||false)},draw:function(a){if(this.cursor&&this.element.style.cursor!=this.cursor)this.element.style.cursor=this.cursor;if(this.element.style.zIndex!=this.root.elementNodeZIndexCounter)this.element.style.zIndex=this.root.elementNodeZIndexCounter;this.root.elementNodeZIndexCounter++;var b=this.currentMatrix;xo=this.xOffset;yo=this.yOffset;if(this.fillBoundingBox&&this.parent&&this.parent.getBoundingBox){var c=this.parent.getBoundingBox();xo+=c[0];yo+=c[1]}var d=CanvasSupport.tMatrixMultiplyPoint(b.slice(0,4).concat([0,0]),xo,yo);var e=this.currentMatrix[4]+d[0];var f=this.currentMatrix[5]+d[1];var g=this.currentMatrix[2];var h=this.currentMatrix[3];var i=this.currentMatrix[0];var j=this.currentMatrix[1];var k=Math.sqrt(g*g+h*h);var l=Math.sqrt(i*i+j*j);if(a.fontFamily!=null)this.element.style.fontFamily=a.fontFamily;var m=CanvasSupport.isCSSTransformSupported();if(m&&!this.noScaling){this.element.style.MozTransform=this.element.style.webkitTransform="matrix("+b.join(",")+")"}else{this.element.style.MozTransform=this.element.style.webkitTransform=""}if(a.fontSize!=null){if(this.noScaling||m){this.element.style.fontSize=a.fontSize+"px"}else{this.element.style.fontSize=a.fontSize*k+"px"}}else{if(this.noScaling||m){this.element.style.fontSize="inherit"}else{this.element.style.fontSize=100*k+"%"}}if(this.noAlpha)this.element.style.opacity=1;else this.element.style.opacity=a.globalAlpha;if(!this.element.parentNode&&this.root.canvas.parentNode){this.element.style.visibility="hidden";this.root.canvas.parentNode.appendChild(this.element);var n=true}var o=this.color||this.fill;if(this.parent){if(!o||!o.length)o=this.parent.color;if(!o||!o.length)o=this.parent.fill}if(!o||!o.length)o=a.fillStyle;if(typeof o=="string"){if(o.search(/^rgba\(/)!=-1){this.element.style.color="rgb("+o.match(/\d+/g).slice(0,3).join(",")+")"}else{this.element.style.color=o}}else if(o.length){this.element.style.color="rgb("+o.slice(0,3).map(Math.floor).join(",")+")"}var p=0,q=0;if(c){this.element.style.width=Math.floor(l*c[2])+"px";this.element.style.height=Math.floor(k*c[3])+"px";this.eWidth=l;this.eHeight=k}else{this.element.style.width="";this.element.style.height="";var r=this.align||this.textAnchor;var s=[0,0];if(r=="center"||r=="middle"){p=-this.element.offsetWidth/2;s[0]="50%"}else if(r=="right"){p=-this.element.offsetWidth;s[0]="100%"}var t=this.valign;if(t=="center"||t=="middle"){q=-this.element.offsetHeight/2;s[1]="50%"}else if(t=="bottom"){q=-this.element.offsetHeight;s[1]="100%"}this.element.style.webkitTransformOrigin=this.element.style.MozTransformOrigin=s.join(" ");this.eWidth=this.element.offsetWidth/l;this.eHeight=this.element.offsetHeight/k}if(m&&!this.noScaling){this.element.style.left=Math.floor(p)+"px";this.element.style.top=Math.floor(q)+"px"}else{this.element.style.left=Math.floor(e+p)+"px";this.element.style.top=Math.floor(f+q)+"px"}if(n)this.element.style.visibility="visible"}});Drawable=Klass(CanvasNode,{pickable:true,strokeMode:"above",ABOVE:"above",BELOW:"below",INSIDE:"inside",initialize:function(a){CanvasNode.initialize.call(this,a)},drawPickingPath:function(a){if(!this.drawGeometry)return;a.beginPath();this.drawGeometry(a)},isPointInPath:function(a,b){return false},isVisible:function(a){var b=this.getAxisAlignedBoundingBox();if(!b)return true;var c=b[0],d=b[0]+b[2],e=b[1],f=b[1]+b[3];var g=this.root.width;var h=this.root.height;if(this.root.drawBoundingBoxes){a.save();var i=this.getBoundingBox();a.beginPath();a.rect(i[0],i[1],i[2],i[3]);a.strokeStyle="green";a.lineWidth=1;a.stroke();a.restore();a.save();CanvasSupport.setTransform(a,[1,0,0,1,0,0],this.currentMatrix);a.beginPath();a.rect(c,e,d-c,f-e);a.strokeStyle="red";a.lineWidth=1.5;a.stroke();a.restore()}var j=!(d<0||c>g||f<0||e>h);return j},createSubtreePath:function(a,b){a.save();if(!b)this.transform(a,true);if(this.drawGeometry)this.drawGeometry(a);for(var c=0;c<this.childNodes.length;c++)this.childNodes[c].createSubtreePath(a);a.restore()},draw:function(a){if(!this.drawGeometry)return;if(this.root.drawBoundingBoxes)this.isVisible(a);var b=a.fillStyle.transformList||a.fillStyle.matrix||a.fillStyle.scale!=null||a.fillStyle.rotation||a.fillStyle.x||a.fillStyle.y;var c=a.strokeStyle.transformList||a.strokeStyle.matrix||a.strokeStyle.scale!=null||a.strokeStyle.rotation||a.strokeStyle.x||a.strokeStyle.y;a.beginPath();this.drawGeometry(a);if(a.strokeOn){switch(this.strokeMode){case this.ABOVE:if(a.fillOn)this.doFill(a,b);this.doStroke(a,c);break;case this.BELOW:this.doStroke(a,c);if(a.fillOn)this.doFill(a,b);break;case this.INSIDE:if(a.fillOn)this.doFill(a,b);a.save();var d=a.lineWidth;a.setLineWidth(1);this.doStroke(a,c);a.setLineWidth(d);a.clip();this.doStroke(a,c);a.restore();break}}else if(a.fillOn){this.doFill(a,b)}this.drawMarkers(a);if(this.clip)a.clip()},doFill:function(a,b){if(b||this.getBoundingBox&&a.fillStyle.units==this.OBJECTBOUNDINGBOX){a.save();if(this.getBoundingBox&&a.fillStyle.units==this.OBJECTBOUNDINGBOX){var c=this.getBoundingBox();var d=c[2];var e=c[3];a.translate(c[0],c[1]);a.scale(d,e)}a.fillStyle.transform(a)}if(this.fillOpacity!=null){var f=a.globalAlpha;a.setGlobalAlpha(f*this.fillOpacity);a.fill();a.globalAlpha=f}else{a.fill()}if(b)a.restore()},doStroke:function(a,b){if(b||this.getBoundingBox&&a.strokeStyle.units==this.OBJECTBOUNDINGBOX){a.save();if(this.getBoundingBox&&a.strokeStyle.units==this.OBJECTBOUNDINGBOX){var c=this.getBoundingBox();var d=c[2];var e=c[3];a.translate(c[0],c[1]);a.scale(d,e)}a.strokeStyle.needMatrixUpdate=true;a.strokeStyle.transform(a);if(d!=null)CanvasSupport.tScale(a.strokeStyle.currentMatrix,d,e);var f=a.strokeStyle.currentMatrix;var g=Math.sqrt(Math.max(f[0]*f[0]+f[1]*f[1],f[2]*f[2]+f[3]*f[3]));a.setLineWidth((a.lineWidth==null?1:a.lineWidth)/g)}if(this.strokeOpacity!=null){var h=a.globalAlpha;a.setGlobalAlpha(h*this.strokeOpacity);a.stroke();a.globalAlpha=h}else{a.stroke()}if(b)a.restore()},drawMarkers:function(a){var b=this.markerStart||this.marker;var c=this.markerEnd||this.marker;var d=this.markerMid||this.marker;if(b&&this.getStartPoint){var e=this.getStartPoint();if(b.orient!=null&&b.orient!="auto")e.angle=b.orient;var f=b.markerUnits=="strokeWidth"?a.lineWidth:1;a.save();a.translate(e.point[0],e.point[1]);a.scale(f,f);a.rotate(e.angle);var g=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),e.point[0],e.point[1]),f,f),e.angle);b.__copyMatrix(g);b.handleDraw(a);a.restore()}if(c&&this.getEndPoint){var e=this.getEndPoint();if(c.orient!=null&&c.orient!="auto")e.angle=c.orient;var f=c.markerUnits=="strokeWidth"?a.lineWidth:1;a.save();a.translate(e.point[0],e.point[1]);a.scale(f,f);a.rotate(e.angle);var g=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),e.point[0],e.point[1]),f,f),e.angle);c.__copyMatrix(g);c.handleDraw(a);a.restore()}if(d&&this.getMidPoints){var h=this.getMidPoints();var f=d.markerUnits=="strokeWidth"?a.lineWidth:1;for(var i=0;i<h.length;i++){var e=h[i];a.save();a.translate(e.point[0],e.point[1]);a.scale(f,f);if(d.orient!=null&&d.orient!="auto")e.angle=c.orient;a.rotate(e.angle);var g=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),e.point[0],e.point[1]),f,f),e.angle);d.__copyMatrix(g);d.handleDraw(a);a.restore()}}},getStartPoint:false,getEndPoint:false,getMidPoints:false,getBoundingBox:false});Line=Klass(Drawable,{x1:0,y1:0,x2:0,y2:0,stroke:true,initialize:function(a,b,c,d,e){this.x1=a;this.y1=b;this.x2=c;this.y2=d;Drawable.initialize.call(this,e)},drawGeometry:function(a){a.moveTo(this.x1,this.y1);a.lineTo(this.x2,this.y2)},getStartPoint:function(){return{point:[this.x1,this.y1],angle:Math.atan2(this.y2-this.y1,this.x2-this.x1)}},getEndPoint:function(){return{point:[this.x2,this.y2],angle:Math.atan2(this.y2-this.y1,this.x2-this.x1)}},getBoundingBox:function(){return[this.x1,this.y1,this.x2-this.x1,this.y2-this.y1]},getLength:function(){return Curves.lineLength([this.x1,this.y1],[this.x2,this.y2])}});Circle=Klass(Drawable,{cx:0,cy:0,radius:10,startAngle:0,endAngle:Math.PI*2,clockwise:false,closePath:true,includeCenter:false,initialize:function(a,b){if(a!=null)this.radius=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){if(this.radius==0)return;if(this.includeCenter)a.moveTo(this.cx,this.cy);a.arc(this.cx,this.cy,this.radius,this.startAngle,this.endAngle,this.clockwise);if(this.closePath){var b=Math.cos(this.endAngle);var c=Math.sin(this.endAngle);a.moveTo(this.cx+b*this.radius,this.cy+c*this.radius);a.closePath()}},isPointInPath:function(a,b){a-=this.cx;b-=this.cy;return a*a+b*b<=this.radius*this.radius},getBoundingBox:function(){return[this.cx-this.radius,this.cy-this.radius,2*this.radius,2*this.radius]}});Ellipse=Klass(Circle,{radiusX:0,radiusY:0,initialize:function(a,b,c){this.radiusX=a;this.radiusY=b;Circle.initialize.call(this,1,c)},drawGeometry:function(a){if(this.radiusX==0||this.radiusY==0)return;var b=.5522847498;var c=this.cx;var d=this.cy;var e=b*this.radiusX;var f=b*this.radiusY;a.moveTo(c+this.radiusX,d);a.bezierCurveTo(c+this.radiusX,d-f,c+e,d-this.radiusY,c,d-this.radiusY);a.bezierCurveTo(c-e,d-this.radiusY,c-this.radiusX,d-f,c-this.radiusX,d);a.bezierCurveTo(c-this.radiusX,d+f,c-e,d+this.radiusY,c,d+this.radiusY);a.bezierCurveTo(c+e,d+this.radiusY,c+this.radiusX,d+f,c+this.radiusX,d)},isPointInPath:function(a,b){a-=this.cx;b-=this.cy;a/=this.radiusX;b/=this.radiusY;return a*a+b*b<=1},getBoundingBox:function(){return[this.cx-this.radiusX,this.cy-this.radiusY,this.radiusX*2,this.radiusY*2]}});Spiral=Klass(Drawable,{cx:0,cy:0,startRadius:0,startAngle:0,endAngle:0,radiusFunction:function(a){return a},initialize:function(a,b){this.endAngle=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){var b=this.cx;var c=this.cy;var d=this.startAngle;var e=this.startRadius+this.radiusFunction(d);a.moveTo(b+Math.cos(d)*e,c-Math.sin(d)*e);if(this.startAngle<this.endAngle){d+=.1;e=this.startRadius+this.radiusFunction(d);while(d<this.endAngle){a.lineTo(b+Math.cos(d)*e,c-Math.sin(d)*e);d+=.1;e=this.startRadius+this.radiusFunction(d)}}else{d-=.1;e=this.startRadius+this.radiusFunction(d);while(d>this.endAngle){a.lineTo(b+Math.cos(d)*e,c-Math.sin(d)*e);d-=.1;e=this.startRadius+this.radiusFunction(d)}}d=this.endAngle;e=this.startRadius+this.radiusFunction(d);a.lineTo(b+Math.cos(d)*e,c-Math.sin(d)*e)},isPointInPath:function(a,b){return false}});Rectangle=Klass(Drawable,{cx:0,cy:0,x2:0,y2:0,width:0,height:0,rx:0,ry:0,centered:false,initialize:function(a,b,c){if(a!=null){this.width=a;this.height=a}if(b!=null)this.height=b;Drawable.initialize.call(this,c)},drawGeometry:function(a){var b=this.cx;var c=this.cy;var d=this.width||this.x2-b;var e=this.height||this.y2-c;if(d==0||e==0)return;if(this.centered){b-=.5*d;c-=.5*e}if(this.rx||this.ry){var f=Math.min(d*.5,this.rx||this.ry);var g=Math.min(e*.5,this.ry||f);var h=.5522847498;var i=h*f;var j=h*g;a.moveTo(b+f,c);a.lineTo(b-f+d,c);a.bezierCurveTo(b-f+d+i,c,b+d,c+g-j,b+d,c+g);a.lineTo(b+d,c+e-g);a.bezierCurveTo(b+d,c+e-g+j,b-f+d+i,c+e,b-f+d,c+e);a.lineTo(b+f,c+e);a.bezierCurveTo(b+f-i,c+e,b,c+e-g+j,b,c+e-g);a.lineTo(b,c+g);a.bezierCurveTo(b,c+g-j,b+f-i,c,b+f,c);a.closePath()}else{if(d<0)b+=d;if(e<0)c+=e;a.rect(b,c,Math.abs(d),Math.abs(e))}},isPointInPath:function(a,b){a-=this.cx;b-=this.cy;if(this.centered){a+=this.width/2;b+=this.height/2}return a>=0&&a<=this.width&&b>=0&&b<=this.height},getBoundingBox:function(){var a=this.cx;var b=this.cy;if(this.centered){a-=this.width/2;b-=this.height/2}return[a,b,this.width,this.height]}});Polygon=Klass(Drawable,{segments:[],closePath:true,initialize:function(a,b){this.segments=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){if(!this.segments||this.segments.length<2)return;var b=this.segments;a.moveTo(b[0],b[1]);for(var c=2;c<b.length;c+=2){a.lineTo(b[c],b[c+1])}if(this.closePath)a.closePath()},isPointInPath:function(a,b){if(!this.segments||this.segments.length<2)return false;var c=this.getBoundingBox();return a>=c[0]&&a<=c[0]+c[2]&&b>=c[1]&&b<=c[1]+c[3]},getStartPoint:function(){if(!this.segments||this.segments.length<2)return{point:[0,0],angle:0};var a=0;if(this.segments.length>2){a=Curves.lineAngle(this.segments.slice(0,2),this.segments.slice(2,4))}return{point:this.segments.slice(0,2),angle:a}},getEndPoint:function(){if(!this.segments||this.segments.length<2)return{point:[0,0],angle:0};var a=0;if(this.segments.length>2){a=Curves.lineAngle(this.segments.slice(-4,-2),this.segments.slice(-2))}return{point:this.segments.slice(-2),angle:a}},getMidPoints:function(){if(!this.segments||this.segments.length<2)return[];var a=this.segments;var b=[];for(var c=2;c<a.length-2;c+=2){var d=a.slice(c-2,c);var e=a.slice(c,c+2);var f=a.slice(c+2,c+4);var g=.5*(Curves.lineAngle(d,e)+Curves.lineAngle(e,f));b.push({point:e,angle:g})}return b},getBoundingBox:function(){var a=Infinity,b=Infinity,c=-Infinity,d=-Infinity;var e=this.segments;for(var f=0;f<e.length;f+=2){var g=e[f],h=e[f+1];if(g<a)a=g;if(g>c)c=g;if(h<b)b=h;if(h>d)d=h}return[a,b,c-a,d-b]}});CatmullRomSpline=Klass(Drawable,{segments:[],loop:false,closePath:false,initialize:function(a,b){this.segments=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){var b=this.currentMatrix[0];var c=this.currentMatrix[1];var d=this.currentMatrix[2];var e=this.currentMatrix[3];var f=b*b+c*c;var g=d*d+e*e;var h=Math.floor(Math.sqrt(Math.max(f,g)));var i=this.compiled;if(!i||i.scale!=h){i=this.compile(h)}for(var j=0;j<i.length;j++){var k=i[j];a[k[0]].apply(a,k[1])}if(this.closePath)a.closePath()},compile:function(a){if(!a)a=1;var b=[];if(this.segments&&this.segments.length>=(this.loop?1:4)){var c=this.segments;if(this.loop){c=c.slice(0);c.unshift(c[c.length-1]);c.push(c[1]);c.push(c[2])}var d=1/(15*(a+.5));var e,f,g,h,i,j;b.push(["moveTo",c[1].slice(0)]);i=c[1];for(var k=1;k<c.length-2;k++){e=c[k-1];f=c[k];g=c[k+1];h=c[k+2];for(var l=0;l<1;l+=d){j=i;i=Curves.catmullRomPoint(e,f,g,h,l);b.push(["lineTo",i])}}i=Curves.catmullRomPoint(e,f,g,h,1);b.push(["lineTo",i])}b.scale=a;this.compiled=b;return b},getBoundingBox:function(){var a=Infinity,b=Infinity,c=-Infinity,d=-Infinity;var e=this.compiled?this.compiled:this.compile();for(var f=0;f<e.length;f++){var g=e[f][1];for(var h=0;h<g.length;h+=2){var i=g[h],j=g[h+1];if(i<a)a=i;if(i>c)c=i;if(j<b)b=j;if(j>d)d=j}}return[a,b,c-a,d-b]},pointAt:function(a){if(!this.segments)return[0,0];if(this.segments.length>=(this.loop?1:4)){var b=this.segments;if(this.loop){b=b.slice(0);b.unshift(b[b.length-1]);b.push(b[1]);b.push(b[2])}var c=a*(b.length-3);var d=Math.floor(c);var e=c-d;var f=b[d],g=b[d+1],h=b[d+2],i=b[d+3];return Curves.catmullRomPoint(f,g,h,i,e)}else{return this.segments[0]}},pointAngleAt:function(a){if(!this.segments)return{point:[0,0],angle:0};if(this.segments.length>=(this.loop?1:4)){var b=this.segments;if(this.loop){b=b.slice(0);b.unshift(b[b.length-1]);b.push(b[1]);b.push(b[2])}var c=a*(b.length-3);var d=Math.floor(c);var e=c-d;var f=b[d],g=b[d+1],h=b[d+2],i=b[d+3];return Curves.catmullRomPointAngle(f,g,h,i,e)}else{return{point:this.segments[0]||[0,0],angle:0}}}});Path=Klass(Drawable,{segments:[],closePath:false,initialize:function(a,b){this.segments=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){var b=this.getSegments();for(var c=0;c<b.length;c++){var d=b[c];a[d[0]].apply(a,d[1])}if(this.closePath)a.closePath()},isPointInPath:function(a,b){var c=this.getBoundingBox();return a>=c[0]&&a<=c[0]+c[2]&&b>=c[1]&&b<=c[1]+c[3]},getBoundingBox:function(){if(!(this.compiled&&this.compiledBoundingBox)){var a=Infinity,b=Infinity,c=-Infinity,d=-Infinity;var e=this.getSegments();for(var f=0;f<e.length;f++){var g=e[f][1];for(var h=0;h<g.length;h+=2){var i=g[h],j=g[h+1];if(i<a)a=i;if(i>c)c=i;if(j<b)b=j;if(j>d)d=j}}this.compiledBoundingBox=[a,b,c-a,d-b]}return this.compiledBoundingBox},getStartPoint:function(){var a=this.getSegments();if(!a||!a[0])return{point:[0,0],angle:0};var b=a[0];var c=b[1];var d=[c[c.length-2],c[c.length-1]];var e=a[1];var f=0;if(e){c2=e[1];f=Curves.lineAngle(d,[c2[c2.length-2],c2[c2.length-1]])}return{point:d,angle:f}},getEndPoint:function(){var a=this.getSegments();if(!a||!a[0])return{point:[0,0],angle:0};var b=a[a.length-1];var c=b[1];var d=[c[c.length-2],c[c.length-1]];var e=a[a.length-2];var f=0;if(e){c2=e[1];f=Curves.lineAngle([c2[c2.length-2],c2[c2.length-1]],d)}return{point:d,angle:f}},getMidPoints:function(){var a=this.getSegments();if(this.vertices)return this.vertices.slice(1,-1);var b=[];for(var c=1;c<a.length-1;c++){var d=a[c-1][1].slice(-2);var e=a[c][1].slice(0,2);if(a[c-1].length>2){var f=a[c-1][1].slice(-4,-2);var g=.5*(Curves.lineAngle(f,d)+Curves.lineAngle(d,e))}else{var g=Curves.lineAngle(d,e)}b.push({point:d,angle:g});var h=a[c][2];if(h!=null){c++;while(a[c]&&a[c][2]==h)c++;c--}}return b},getSegments:function(){if(typeof this.segments=="string"){if(!this.compiled||this.segments!=this.compiledSegments){this.compiled=this.compileSVGPath(this.segments);this.compiledSegments=this.segments}}else if(!this.compiled){this.compiled=Object.clone(this.segments)}return this.compiled},compileSVGPath:function(a){var b=a.split(/(?=[a-z])/i);var c=0;var d=0;var e,f;var g;var h=[];for(var i=0;i<b.length;i++){var j=b[i];var k=j.match(/[a-z]/i);if(!k)return[];k=k[0];var l=j.match(/[+-]?\d+(\.\d+(e\d+(\.\d+)?)?)?/gi);if(l)l=l.map(parseFloat);switch(k){case"M":c=l[0];d=l[1];e=f=null;h.push(["moveTo",[c,d]]);break;case"m":c+=l[0];d+=l[1];e=f=null;h.push(["moveTo",[c,d]]);break;case"L":c=l[0];d=l[1];e=f=null;h.push(["lineTo",[c,d]]);break;case"l":c+=l[0];d+=l[1];e=f=null;h.push(["lineTo",[c,d]]);break;case"H":c=l[0];e=f=null;h.push(["lineTo",[c,d]]);break;case"h":c+=l[0];e=f=null;h.push(["lineTo",[c,d]]);break;case"V":d=l[0];e=f=null;h.push(["lineTo",[c,d]]);break;case"v":d+=l[0];e=f=null;h.push(["lineTo",[c,d]]);break;case"C":c=l[4];d=l[5];e=l[2];f=l[3];h.push(["bezierCurveTo",l]);break;case"c":h.push(["bezierCurveTo",[l[0]+c,l[1]+d,l[2]+c,l[3]+d,l[4]+c,l[5]+d]]);e=c+l[2];f=d+l[3];c+=l[4];d+=l[5];break;case"S":if(e==null||!g.match(/[sc]/i)){e=c;f=d}h.push(["bezierCurveTo",[c-(e-c),d-(f-d),l[0],l[1],l[2],l[3]]]);e=l[0];f=l[1];c=l[2];d=l[3];break;case"s":if(e==null||!g.match(/[sc]/i)){e=c;f=d}h.push(["bezierCurveTo",[c-(e-c),d-(f-d),c+l[0],d+l[1],c+l[2],d+l[3]]]);e=c+l[0];f=d+l[1];c+=l[2];d+=l[3];break;case"Q":e=l[0];f=l[1];c=l[2];d=l[3];h.push(["quadraticCurveTo",l]);break;case"q":h.push(["quadraticCurveTo",[l[0]+c,l[1]+d,l[2]+c,l[3]+d]]);e=c+l[0];f=d+l[1];c+=l[2];d+=l[3];break;case"T":if(e==null||!g.match(/[qt]/i)){e=c;f=d}else{e=c-(e-c);f=d-(f-d)}h.push(["quadraticCurveTo",[e,f,l[0],l[1]]]);e=c-(e-c);f=d-(f-d);c=l[0];d=l[1];break;case"t":if(e==null||!g.match(/[qt]/i)){e=c;f=d}else{e=c-(e-c);f=d-(f-d)}h.push(["quadraticCurveTo",[e,f,c+l[0],d+l[1]]]);c+=l[0];d+=l[1];break;case"A":var m=this.solveArc(c,d,l);for(var n=0;n<m.length;n++)m[n][2]=i;h.push.apply(h,m);c=l[5];d=l[6];break;case"a":l[5]+=c;l[6]+=d;var m=this.solveArc(c,d,l);for(var n=0;n<m.length;n++)m[n][2]=i;h.push.apply(h,m);c=l[5];d=l[6];break;case"Z":h.push(["closePath",[]]);break;case"z":h.push(["closePath",[]]);break}g=k}return h},solveArc:function(a,b,c){var d=c[0];var e=c[1];var f=c[2];var g=c[3];var h=c[4];var i=c[5];var j=c[6];var k=this.arcToSegments(i,j,d,e,g,h,f,a,b);var l=[];for(var m=0;m<k.length;m++){l.push(["bezierCurveTo",this.segmentToBezier.apply(this,k[m])])}return l},arcToSegments:function(a,b,c,d,e,f,g,h,i){var j=g*(Math.PI/180);var k=Math.sin(j);var l=Math.cos(j);c=Math.abs(c);d=Math.abs(d);var m=l*(h-a)*.5+k*(i-b)*.5;var n=l*(i-b)*.5-k*(h-a)*.5;var o=m*m/(c*c)+n*n/(d*d);if(o>1){o=Math.sqrt(o);c*=o;d*=o}var p=l/c;var q=k/c;var r=-k/d;var s=l/d;var t=p*h+q*i;var u=r*h+s*i;var v=p*a+q*b;var w=r*a+s*b;var x=(v-t)*(v-t)+(w-u)*(w-u);var y=1/x-.25;if(y<0)y=0;var z=Math.sqrt(y);if(f==e)z=-z;var A=.5*(t+v)-z*(w-u);var B=.5*(u+w)+z*(v-t);var C=Math.atan2(u-B,t-A);var D=Math.atan2(w-B,v-A);var E=D-C;if(E<0&&f==1){E+=2*Math.PI}else if(E>0&&f==0){E-=2*Math.PI}var F=Math.ceil(Math.abs(E/(Math.PI*.5+.001)));var G=[];for(var H=0;H<F;H++){var I=C+H*E/F;var J=C+(H+1)*E/F;G[H]=[A,B,I,J,c,d,k,l]}return G},segmentToBezier:function(a,b,c,d,e,f,g,h){var i=h*e;var j=-g*f;var k=g*e;var l=h*f;var m=.5*(d-c);var n=8/3*Math.sin(m*.5)*Math.sin(m*.5)/Math.sin(m);var o=a+Math.cos(c)-n*Math.sin(c);var p=b+Math.sin(c)+n*Math.cos(c);var q=a+Math.cos(d);var r=b+Math.sin(d);var s=q+n*Math.sin(d);var t=r-n*Math.cos(d);return[i*o+j*p,k*o+l*p,i*s+j*t,k*s+l*t,i*q+j*r,k*q+l*r]},getLength:function(){var a=this.getSegments();if(a.arcLength==null){a.arcLength=0;var b=0,c=0;for(var d=0;d<a.length;d++){var e=a[d][1];if(e.length<2)continue;switch(a[d][0]){case"bezierCurveTo":a[d][3]=Curves.cubicLength([b,c],[e[0],e[1]],[e[2],e[3]],[e[4],e[5]]);break;case"quadraticCurveTo":a[d][3]=Curves.quadraticLength([b,c],[e[0],e[1]],[e[2],e[3]]);break;case"lineTo":a[d][3]=Curves.lineLength([b,c],[e[0],e[1]]);break}if(a[d][3])a.arcLength+=a[d][3];b=e[e.length-2];c=e[e.length-1]}}return a.arcLength},pointAngleAt:function(a,b){var c=[];var d=this.getSegments();var e=this.getLength();var f=0,g=0;for(var h=0;h<d.length;h++){var i=d[h];if(i[1].length<2)continue;if(i[0]!="moveTo"){c.push([f,g,i])}f=i[1][i[1].length-2];g=i[1][i[1].length-1]}if(c.length<1)return{point:[f,g],angle:0};if(a>=1){var j=1;var i=c[c.length-1]}else if(b&&b.discrete){var k=Math.floor(a*c.length);var i=c[k];var j=0}else if(b&&b.linear){var k=a*c.length;var j=k-Math.floor(k);var i=c[Math.floor(k)]}else{var l=a*e;var m=0,k,j;for(var h=0;h<c.length;h++){if(m+c[h][2][3]>l){k=h;j=(l-m)/c[h][2][3];break}m+=c[h][2][3]}var i=c[k]}var n=0;var o=i[2][0];var p=i[2][1];switch(o){case"bezierCurveTo":return Curves.cubicLengthPointAngle([i[0],i[1]],[p[0],p[1]],[p[2],p[3]],[p[4],p[5]],j);break;case"quadraticCurveTo":return Curves.quadraticLengthPointAngle([i[0],i[1]],[p[0],p[1]],[p[2],p[3]],j);break;case"lineTo":f=Curves.linearValue(i[0],p[0],j);g=Curves.linearValue(i[1],p[1],j);n=Curves.lineAngle([i[0],i[1]],[p[0],p[1]],j);break}return{point:[f,g],angle:n}}});ImageNode=Klass(Drawable,{centered:false,usePattern:false,sX:0,sY:0,sWidth:null,sHeight:null,dX:0,dY:0,dWidth:null,dHeight:null,initialize:function(a,b){this.image=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){if(Object.isImageLoaded(this.image)){var b=this.dWidth==null?this.image.width:this.dWidth;var c=this.dHeight==null?this.image.height:this.dHeight;var d=this.dX+(this.centered?-b*.5:0);var e=this.dY+(this.centered?-c*.5:0);if(this.dWidth!=null){if(this.sWidth!=null){a.drawImage(this.image,this.sX,this.sY,this.sWidth,this.sHeight,d,e,b,c)}else{a.drawImage(this.image,d,e,b,c)}}else{b=this.image.width;c=this.image.height;if(this.usePattern){if(!this.imagePattern)this.imagePattern=new Pattern(this.image,"repeat");var f=this.imagePattern.compiled;if(!f)f=this.imagePattern.compile(a);a.save();a.beginPath();a.rect(d,e,b,c);a.setFillStyle(f);a.fill();a.restore();a.beginPath()}else{a.drawImage(this.image,d,e)}}}else{var b=this.dWidth;var c=this.dHeight;if(!(b&&c))return;var d=this.dX+(this.centered?-b*.5:0);var e=this.dY+(this.centered?-c*.5:0)}a.rect(d,e,b,c)},drawPickingPath:function(a){var b=this.dX+(this.centered?-this.image.width*.5:0);var c=this.dY+(this.centered?-this.image.height*.5:0);var d=this.dWidth;var e=this.dHeight;if(this.dWidth==null){d=this.image.width;e=this.image.height}a.rect(b,c,d,e)},isPointInPath:function(a,b){a-=this.dX;b-=this.dY;if(this.centered){a+=this.image.width*.5;b+=this.image.height*.5}var c=this.dWidth;var d=this.dHeight;if(this.dWidth==null){c=this.image.width;d=this.image.height}return a>=0&&a<=c&&b>=0&&b<=d},getBoundingBox:function(){x=this.dX;y=this.dY;if(this.centered){x-=this.image.width*.5;y-=this.image.height*.5}var a=this.dWidth;var b=this.dHeight;if(this.dWidth==null){a=this.image.width;b=this.image.height}return[x,y,a,b]}});ImageNode.load=function(a){var b=new Image;b.src=a;var c=new ImageNode(b);return c};TextNode=Klass(Drawable,{text:"Text",align:"start",baseline:"alphabetic",accuratePicking:false,asPath:false,pathGeometry:null,maxWidth:null,width:0,height:20,cx:0,cy:0,__drawMethodName:"draw"+CanvasSupport.getTextBackend(),__pickingMethodName:"drawPickingPath"+CanvasSupport.getTextBackend(),initialize:function(a,b){this.lastText=this.text;this.text=a;Drawable.initialize.call(this,b)},drawGeometry:function(a){this.drawUsing(a,this.__drawMethodName)},drawPickingPath:function(a){this.drawUsing(a,this.__pickingMethodName)},drawUsing:function(a,b){if(!this.text||this.text.length==0)return;if(this.lastText!=this.text||this.lastStyle!=a.font){this.dimensions=this.measureText(a);this.lastText=this.text;this.lastStyle=a.font}if(this[b])this[b](a)},measureText:function(a){var b="measureText"+CanvasSupport.getTextBackend().capitalize();if(this[b]){return this[b](a)}else{return{width:0,height:0}}},computeXForAlign:function(){if(this.align=="left")return 0;else if(this.align=="right")return-this.dimensions.width;else if(this.align=="center")return-this.dimensions.width*.5},measureTextHTML5:function(a){return{width:a.measureText(this.text).width,height:20}},drawHTML5:function(a){a.fillText(this.text,this.cx,this.cy,this.maxWidth)},drawPickingPathHTML5:function(a){var b=15;var c=this.cy-b;a.rect(this.cx,c,this.dimensions.width,this.dimensions.height)},measureTextMozText:function(a){return{width:a.mozMeasureText(this.text),height:20}},drawMozText:function(a){var b=this.cx+this.computeXForAlign();var c=this.cy+0;if(this.pathGeometry){this.pathGeometry.draw(a);a.mozDrawTextAlongPath(this.text,this.path)}else{a.save();a.translate(b,c);if(this.asPath){a.mozPathText(this.text)}else{a.mozDrawText(this.text)}a.restore()}},drawPickingPathMozText:function(a){var b=this.cx+this.computeXForAlign();var c=this.cy+0;if(this.pathGeometry){this.pathGeometry.draw(a)}else if(!this.accuratePicking){var d=15;var e=c-d;a.rect(b,e,this.dimensions.width,this.dimensions.height)}else{a.save();a.translate(b,c);a.mozPathText(this.text);a.restore()}},drawDrawString:function(a){var b=this.cx+this.computeXForAlign();var c=this.cy+0;a.drawString(b,c,this.text)},measureTextPerfectWorld:function(a){return a.measureText(this.text)},drawPerfectWorld:function(a){if(this.pathGeometry){this.pathGeometry.draw(a);if(this.asPath)a.pathTextAlongPath(this.text);else a.drawTextAlongPath(this.text)}else if(this.asPath){a.pathText(this.text)}else{a.drawText(this.text)}},drawPickingPathPerfectWorld:function(a){if(this.accuratePicking){if(this.pathGeometry){a.pathTextAlongPath(this.text)}else{a.pathText(this.text)}}else{if(this.pathGeometry){a.textRectAlongPath(this.text)}else{a.textRect(this.text)}}}});Gradient=Klass({type:"linear",isPattern:true,startX:0,startY:0,endX:1,endY:0,startRadius:0,endRadius:1,colorStops:[],initialize:function(a){this.colorStops=[[0,"#000000"],[1,"#FFFFFF"]];if(a)Object.extend(this,a)},compile:function(a){if(this.type=="linear"){var b=a.createLinearGradient(this.startX,this.startY,this.endX,this.endY)}else{var b=a.createRadialGradient(this.startX,this.startY,this.startRadius,this.endX,this.endY,this.endRadius)}for(var c=0;c<this.colorStops.length;c++){var d=this.colorStops[c];if(typeof d[1]=="string"){b.addColorStop(d[0],d[1])}else{var e=d[1];var f=e.length==3?1:e[3];var g="rgba("+e.slice(0,3).map(Math.round).join(",")+", "+f+")";b.addColorStop(d[0],g)}}Object.extend(b,Transformable.prototype);b.transformList=this.transformList;b.scale=this.scale;b.x=this.x;b.y=this.y;b.matrix=this.matrix;b.rotation=this.rotation;b.units=this.units;if(!b.isMockObject)this.compiled=b;return b}});Pattern=Klass({isPattern:true,repeat:"repeat",initialize:function(a,b){this.image=a;if(b)this.repeat=b},compile:function(a){var b=a.createPattern(this.image,this.repeat);Object.extend(b,Transformable.prototype);b.transformList=this.transformList;b.scale=this.scale;b.x=this.x;b.y=this.y;b.matrix=this.matrix;b.rotation=this.rotation;b.units=this.units;if(!b.isMockObject)this.compiled=b;return b}});SVGParser={load:function(a,b){if(!b.onSuccess)throw"Need to provide an onSuccess function.";if(!b.filename)b.filename=a;var c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");c.open("GET",a,true);c.overrideMimeType("text/xml");var d=false;c.onreadystatechange=function(){if(c.readyState==4){if(c.status==200||c.status==0){try{var e=c.responseXML;var f=SVGParser.parse(e,b);f.svgRootElement=e}catch(g){if(b.onFailure)b.onFailure(c,g,a,b);return}b.onSuccess(f,c,a,b)}else{if(b.onFailure&&!d)b.onFailure(c,null,a,b)}}else if(c.readyState==3){if(b.onLoading)b.onLoading(c,a,b)}};try{c.send(null)}catch(e){if(b.onFailure){b.onFailure(c,e,a,b);d=true}c.abort()}},parse:function(a,b){var c=new CanvasNode;var d=b.width,e=b.height,f=b.fontSize;c.innerWidth=d||window.innerWidth;c.innerHeight=e||window.innerHeight;c.innerSize=Math.sqrt(d*d+e*e)/Math.sqrt(2);c.fontSize=f||12;c.filename=b.filename||".";var g={};var h={ids:{},classes:{},tags:{}};c.color=b.currentColor||"black";this.parseChildren(a,c,g,h);c.defs=g;c.style=h;return c},parsePreserveAspectRatio:function(a,b,c,d,e){var a=a||"";var f=a.split(/\s+/);var g=f[0]=="defer";if(g)f.shift();var h=f[0]||"xMidYMid";var i=f[1]||"meet";var j=b/d;var k=c/e;var l={x:0,y:0,w:j,h:k};if(h=="none")return l;l.w=l.h=(i=="meet"?Math.min:Math.max)(j,k);var m=h.slice(1,4).toLowerCase();var n=h.slice(5,8).toLowerCase();var o=this.SVGAlignMap[m]||0;var p=this.SVGAlignMap[n]||0;l.x=o*(b-d*l.w);l.y=p*(c-e*l.h);return l},SVGAlignMap:{min:0,mid:.5,max:1},SVGTagMapping:{svg:function(a,b,c,d){var e=new Rectangle;e.width=0;e.height=0;e.doFill=function(){};e.doStroke=function(){};e.drawMarkers=function(){};e.fill="black";e.stroke="none";var f=a.getAttribute("viewBox");var g=a.getAttribute("width");var h=a.getAttribute("height");if(!g)g=h;else if(!h)h=g;if(g){var i=this.parseUnit(g,b,"x");var j=this.parseUnit(h,b,"y")}if(f){xywh=f.match(/[-+]?\d+/g).map(parseFloat);e.cx=xywh[0];e.cy=xywh[1];e.width=xywh[2];e.height=xywh[3];var k=b.innerWidth=e.width;var l=b.innerHeight=e.height;b.innerSize=Math.sqrt(k*k+l*l)/Math.sqrt(2);if(a.getAttribute("overflow")!="visible")e.clip=true}if(g){if(f){var m=a.getAttribute("preserveAspectRatio");var n=this.parsePreserveAspectRatio(m,i,j,e.width,e.height);e.cx-=n.x/n.w;e.cy-=n.y/n.h;e.width=i/n.w;e.height=j/n.h;e.x+=n.x;e.y+=n.y;e.scale=[n.w,n.h]}b.docWidth=i;b.docHeight=j}return e},marker:function(a,b){var c=new CanvasNode;c.draw=function(a){if(this.overflow!="hidden"&&this.viewBox)return;a.beginPath();a.rect(this.viewBox[0],this.viewBox[1],this.viewBox[2],this.viewBox[3]);a.clip()};var d=-this.parseUnit(a.getAttribute("refX"),b,"x")||0;var e=-this.parseUnit(a.getAttribute("refY"),b,"y")||0;c.transformList=[["translate",[d,e]]];c.markerUnits=a.getAttribute("markerUnits")||"strokeWidth";c.markerWidth=this.parseUnit(a.getAttribute("markerWidth"),b,"x")||3;c.markerHeight=this.parseUnit(a.getAttribute("markerHeight"),b,"y")||3;c.overflow=a.getAttribute("overflow")||"hidden";c.viewBox=a.getAttribute("viewBox");c.orient=a.getAttribute("orient")||0;if(c.orient&&c.orient!="auto")c.orient=parseFloat(c.orient)*SVGMapping.DEG_TO_RAD_FACTOR;if(c.viewBox){c.viewBox=c.viewBox.strip().split(/[\s,]+/g).map(parseFloat);var f=c.viewBox[2]-c.viewBox[0];var g=c.viewBox[3]-c.viewBox[1];if(c.markerWidth){var h=sy=Math.min(c.markerWidth/f,c.markerHeight/g);c.transformList.unshift(["scale",[h,sy]])}}return c},clipPath:function(a,b){var c=new CanvasNode;c.units=a.getAttribute("clipPathUnits");return c},title:function(a,b){b.root.title=a.textContent},desc:function(a,b){b.root.description=a.textContent},metadata:function(a,b){b.root.metadata=a},parseAnimateTag:function(a,b){var c=SVGParser.SVGTagMapping.parseTime(a.getAttribute("begin"));var d=SVGParser.SVGTagMapping.parseTime(a.getAttribute("dur"));var e=SVGParser.SVGTagMapping.parseTime(a.getAttribute("end"));if(d==null)d=e-c;d=isNaN(d)?0:d;var f=a.getAttribute("attributeName");var g=a.getAttribute("fill");if(b.tagName=="rect"){if(f=="x")f="cx";if(f=="y")f="cy"}var h=a.getAttribute("accumulate")=="sum";var i=a.getAttribute("additive");if(i)i=i=="sum";else i=h;var j=a.getAttribute("repeatCount");if(j=="indefinite")j=true;else j=parseFloat(j);if(!j&&d>0){var k=a.getAttribute("repeatDur");if(k=="indefinite")j=true;else j=SVGParser.SVGTagMapping.parseTime(k)/d}return{after:isNaN(c)?0:c,duration:d,restart:a.getAttribute("restart"),calcMode:a.getAttribute("calcMode"),additive:i,accumulate:h,repeat:j,variable:f,fill:g}},parseTime:function(a){if(!a)return null;if(a.match(/[0-9]$/)){var b=a.split(":");var c=b[b.length-1]||0;var d=b[b.length-2]||0;var e=b[b.length-3]||0;return(parseFloat(e)*3600+parseFloat(d)*60+parseFloat(c))*1e3}else{var f=60;if(a.match(/s$/i))f=1;else if(a.match(/h$/i))f=3600;return parseFloat(a)*f*1e3}},animate:function(a,b){var c=this.parseUnit(a.getAttribute("from"),b,"x");var d=this.parseUnit(a.getAttribute("to"),b,"x");var e=this.parseUnit(a.getAttribute("by"),b,"x");var f=SVGParser.SVGTagMapping.parseAnimateTag(a,b);if(a.getAttribute("values")){var g=this;var h=a.getAttribute("values");h=h.split(";").map(function(a){var c=a.split(/[, ]+/);if(c.length>2){return c.map(function(a){return g.parseUnit(a,b,"x")})}else if(c.length>1){return[g.parseUnit(c[0],b,"x"),g.parseUnit(c[1],b,"y")]}else{return g.parseUnit(a,b,"x")}})}else{if(d==null)d=c+e}b.after(f.after,function(){if(f.fill=="remove"){var a=Object.clone(this[f.variable]);this.after(f.duration,function(){this[f.variable]=a})}if(h){if(f.additive){var b=this[f.variable];h=h.map(function(a){return Object.sum(a,b)})}var g=0;var i=[];if(h[0]instanceof Array){for(var j=1;j<h.length;j++){var k=Object.sub(h[j]-h[j-1]);var l=Math.sqrt(k.reduce(function(a,b){return a+b*b},0));i.push(l);g+=l}}else{for(var j=1;j<h.length;j++){var l=Math.abs(h[j]-h[j-1]);i.push(l);g+=l}}var m=function(a){if(a==1){this[f.variable]=h[h.length-1]}else{if(f.calcMode=="paced"){var b=a*g;var c=0,d,e;for(var j=0;j<i.length;j++){if(c+i[j]>b){d=j;e=(b-c)/i[j];break}c+=i[j]}var k=d;var l=k+1}else{var d=a*(h.length-1);var k=Math.floor(d);var e=d-k;var l=k+1}this.tweenVariable(f.variable,h[k],h[l],e,f.calcMode)}};this.animate(m,c,d,f.duration,"linear",{repeat:f.repeat,additive:f.additive,accumulate:f.accumulate})}else{if(c==null){c=this[f.variable];if(e!=null)d=c+e}if(f.additive){c=Object.sum(c,this[f.variable]);d=Object.sum(d,this[f.variable])}this.animate(f.variable,c,d,f.duration,f.calcMode,{repeat:f.repeat,additive:f.additive,accumulate:f.accumulate})}})},set:function(a,b){var c=a.getAttribute("to");var d=SVGParser.SVGTagMapping.parseAnimateTag(a,b);b.after(d.after,function(){if(d.fill=="remove"){var a=Object.clone(this[d.variable]);this.after(d.duration,function(){this[d.variable]=a})}this[d.variable]=c})},animateMotion:function(a,b){var c;if(a.getAttribute("path")){c=new Path(a.getAttribute("path"))}else if(a.getAttribute("values")){var d=a.getAttribute("values");c=new Path("M"+d.split(";").join("L"))}else if(a.getAttribute("from")||a.getAttribute("to")||a.getAttribute("by")){var e=a.getAttribute("from");var f=a.getAttribute("to");var g=a.getAttribute("by");if(!e)e="0,0";if(!f)f="l"+g;else f="L"+f;c=new Path("M"+e+f)}var h=new CanvasNode;h.__motionPath=c;var i=a.getAttribute("rotate");var j=SVGParser.SVGTagMapping.parseAnimateTag(a,b);b.after(j.after,function(){if(j.fill=="remove"){var a=this.x,b=this.y;this.after(j.duration,function(){this.x=a;this.y=b})}var c=function(a){var b=h.__motionPath.pointAngleAt(a,{discrete:j.calcMode=="discrete",linear:j.calcMode=="linear"});this.x=b.point[0];this.y=b.point[1];if(i=="auto"){this.rotation=b.angle}else if(i=="auto-reverse"){this.rotation=b.angle+Math.PI}};this.animate(c,0,1,j.duration,"linear",{repeat:j.repeat,additive:j.additive,accumulate:j.accumulate})});return h},mpath:function(a,b,c){var d=a.getAttribute("xlink:href");d=d.replace(/^#/,"");this.getDef(c,d,function(a){b.__motionPath=a})},animateColor:function(a,b,c){var d=a.getAttribute("from");var e=a.getAttribute("to");d=SVGParser.SVGMapping.__parseStyle(d,null,c);e=SVGParser.SVGMapping.__parseStyle(e,null,c);var f=SVGParser.SVGTagMapping.parseAnimateTag(a,b);b.after(f.after,function(){if(f.fill=="remove"){var a=Object.clone(this[f.variable]);this.after(f.duration,function(){this[f.variable]=a})}this.animate(f.variable,d,e,f.duration,"linear",{repeat:f.repeat,additive:f.additive,accumulate:f.accumulate})})},animateTransform:function(a,b){var c=a.getAttribute("from");var d=a.getAttribute("to");var e=a.getAttribute("by");var f=SVGParser.SVGTagMapping.parseAnimateTag(a,b);if(c)c=c.split(/[ ,]+/).map(parseFloat);if(d)d=d.split(/[ ,]+/).map(parseFloat);if(e)e=e.split(/[ ,]+/).map(parseFloat);f.variable=a.getAttribute("type");if(f.variable=="rotate"){f.variable="rotation";if(c)c=c.map(function(a){return a*Math.PI/180});if(d)d=d.map(function(a){return a*Math.PI/180});if(e)e=e.map(function(a){return a*Math.PI/180})}else if(f.variable.match(/^skew/)){if(c)c=c.map(function(a){return a*Math.PI/180});if(d)d=d.map(function(a){return a*Math.PI/180});if(e)e=e.map(function(a){return a*Math.PI/180})}if(d==null)d=Object.sum(c,e);b.after(f.after,function(){if(f.variable=="translate"){if(c==null){c=[this.x,this.y];if(e!=null)d=Object.sum(c,e)}if(f.fill=="remove"){var a=this.x;var b=this.y;this.after(f.duration,function(){this.x=a;this.y=b})}this.animate("x",c[0],d[0],f.duration,"linear",{repeat:f.repeat,additive:f.additive,accumulate:f.accumulate});if(c[1]!=null){this.animate("y",c[1],d[1],f.duration,"linear",{repeat:f.repeat,additive:f.additive,accumulate:f.accumulate})}}else{if(c){if(c.length==1)c=c[0]}if(d){if(d.length==1)d=d[0]}if(e){if(e.length==1)e=e[0]}if(c==null){c=this[f.variable];if(e!=null)d=Object.sum(c,e)}if(f.variable=="scale"&&f.additive){f.additive=false}if(f.fill=="remove"){var g=Object.clone(this[f.variable]);this.after(f.duration,function(){this[f.variable]=g})}this.animate(f.variable,c,d,f.duration,"linear",{repeat:f.repeat,additive:f.additive,accumulate:f.accumulate})}})},a:function(a,b){var c=a.getAttribute("xlink:href")||a.getAttribute("href");var d=a.getAttribute("target");var e=new LinkNode(c,d);return e},use:function(a,b,c,d){var e=a.getAttribute("xlink:href")||a.getAttribute("href");var f=new CanvasNode;if(e){e=e.replace(/^#/,"");this.getDef(c,e,function(a){var b=a.clone();var c=f.parent;if(c){if(f.stroke)b.stroke=f.stroke;if(f.fill)b.fill=f.fill;f.append(b)}else{f=b}})}return f},image:function(a,b,c,d){var e=a.getAttribute("xlink:href")||a.getAttribute("href");if(e&&e.search(/^[a-z]+:/i)!=0){e=b.root.filename.split("/").slice(0,-1).join("/")+"/"+e}var f=new ImageNode(e?Object.loadImage(e):null);f.fill="none";f.dX=this.parseUnit(a.getAttribute("x"),b,"x")||0;f.dY=this.parseUnit(a.getAttribute("y"),b,"y")||0;f.srcWidth=this.parseUnit(a.getAttribute("width"),b,"x");f.srcHeight=this.parseUnit(a.getAttribute("height"),b,"y");return f},path:function(a){return new Path(a.getAttribute("d"))},polygon:function(a){return new Polygon(a.getAttribute("points").toString().strip().split(/[\s,]+/).map(parseFloat))},polyline:function(a){return new Polygon(a.getAttribute("points").toString().strip().split(/[\s,]+/).map(parseFloat),{closePath:false})},rect:function(a,b){var c=new Rectangle(this.parseUnit(a.getAttribute("width"),b,"x"),this.parseUnit(a.getAttribute("height"),b,"y"));c.cx=this.parseUnit(a.getAttribute("x"),b,"x")||0;c.cy=this.parseUnit(a.getAttribute("y"),b,"y")||0;c.rx=this.parseUnit(a.getAttribute("rx"),b,"x")||0;c.ry=this.parseUnit(a.getAttribute("ry"),b,"y")||0;return c},line:function(a,b){var c=this.parseUnit(a.getAttribute("x1"),b,"x")||0;var d=this.parseUnit(a.getAttribute("y1"),b,"y")||0;var e=this.parseUnit(a.getAttribute("x2"),b,"x")||0;var f=this.parseUnit(a.getAttribute("y2"),b,"y")||0;var g=new Line(c,d,e,f);return g},circle:function(a,b){var c=new Circle(this.parseUnit(a.getAttribute("r"),b)||0);c.cx=this.parseUnit(a.getAttribute("cx"),b,"x")||0;c.cy=this.parseUnit(a.getAttribute("cy"),b,"y")||0;return c},ellipse:function(a,b){var c=new Ellipse(this.parseUnit(a.getAttribute("rx"),b,"x")||0,this.parseUnit(a.getAttribute("ry"),b,"y")||0);c.cx=this.parseUnit(a.getAttribute("cx"),b,"x")||0;c.cy=this.parseUnit(a.getAttribute("cy"),b,"y")||0;return c},text:function(a,b){if(false){var c=new TextNode(a.textContent.strip());c.setAsPath(true);c.cx=this.parseUnit(a.getAttribute("x"),b,"x")||0;c.cy=this.parseUnit(a.getAttribute("y"),b,"y")||0;return c}else{var d=E("div",a.textContent.strip());d.style.marginTop="-1em";d.style.whiteSpace="nowrap";var c=new ElementNode(d);c.xOffset=this.parseUnit(a.getAttribute("x"),b,"x")||0;c.yOffset=this.parseUnit(a.getAttribute("y"),b,"y")||0;return c}},style:function(a,b,c,d){this.parseStyle(a,d)},defs:function(a,b,c,d){return new CanvasNode({visible:false})},linearGradient:function(a,b,c,d){var e=new Gradient({type:"linear"});e.color=b.color;if(a.getAttribute("color")){SVGParser.SVGMapping.color(e,a.getAttribute("color"),c,d)}e.svgNode=a;var f=a.getAttribute("x1");var g=a.getAttribute("y1");var h=a.getAttribute("x2");var i=a.getAttribute("y2");var j=a.getAttribute("gradientTransform");e.units=a.getAttribute("gradientUnits")||"objectBoundingBox";if(f)e.startX=parseFloat(f)*(f.charAt(f.length-1)=="%"?.01:1);if(g)e.startY=parseFloat(g)*(g.charAt(g.length-1)=="%"?.01:1);if(h)e.endX=parseFloat(h)*(h.charAt(h.length-1)=="%"?.01:1);if(i)e.endY=parseFloat(i)*(i.charAt(i.length-1)=="%"?.01:1);if(j)this.applySVGTransform(e,j,c,d);this.parseStops(e,a,c,d);return e},radialGradient:function(a,b,c,d){var e=new Gradient({type:"radial"});e.color=b.color;if(a.getAttribute("color")){SVGParser.SVGMapping.color(e,a.getAttribute("color"),c,d)}e.svgNode=a;var f=a.getAttribute("r");var g=a.getAttribute("fx");var h=a.getAttribute("fy");var i=a.getAttribute("cx");var j=a.getAttribute("cy");var k=a.getAttribute("gradientTransform");e.units=a.getAttribute("gradientUnits")||"objectBoundingBox";if(f)e.endRadius=parseFloat(f)*(f.charAt(f.length-1)=="%"?.01:1);if(g)e.startX=parseFloat(g)*(g.charAt(g.length-1)=="%"?.01:1);if(h)e.startY=parseFloat(h)*(h.charAt(h.length-1)=="%"?.01:1);if(i)e.endX=parseFloat(i)*(i.charAt(i.length-1)=="%"?.01:1);if(j)e.endY=parseFloat(j)*(j.charAt(j.length-1)=="%"?.01:1);if(k)this.applySVGTransform(e,k,c,d);this.parseStops(e,a,c,d);return e}},parseChildren:function(a,b,c,d){var e=[];var f=b;for(var g=0;g<a.childNodes.length;g++){var h=a.childNodes[g];var i=false;if(h.childNodes){if(h.tagName){if(this.SVGTagMapping[h.tagName]){i=this.SVGTagMapping[h.tagName].call(this,h,b,c,d)}else{i=new CanvasNode}if(i){i.root=b.root;i.fontSize=f.fontSize;i.strokeWidth=f.strokeWidth;if(h.attributes){for(var j=0;j<h.attributes.length;j++){var k=h.attributes[j];if(this.SVGMapping[k.nodeName])this.SVGMapping[k.nodeName](i,k.nodeValue,c,d)}}if(i.id){this.setDef(c,i.id,i)}i.tagName=h.tagName;this.applySVGTransform(i,h.getAttribute("transform"),c,d);this.applySVGStyle(i,h.getAttribute("style"),c,d);if(i.tagName&&d.tags[i.tagName])this.applySVGStyle(i,d.tags[i.tagName],c,d);if(i.className&&d.classes[i.className])this.applySVGStyle(i,d.classes[i.className],c,d);if(i.id&&d.ids[i.id])this.applySVGStyle(i,d.ids[i.id],c,d);if(!i.marker)i.marker=f.marker;if(!i.markerStart)i.markerStart=f.markerStart;if(!i.markerEnd)i.markerEnd=f.markerEnd;if(!i.markerMid)i.markerMid=f.markerMid}}if(i&&i.setRoot){i.zIndex=g;b.append(i);this.parseChildren(h,i,c,d)}}}},parseStyle:function(a,b){var c=a.textContent;var d=c.split(/\}/m);for(var e=0;e<d.length;e++){var f=d[e];var g=f.split(/\{/m);if(g.length<2)continue;var h=g[0].strip();var i=g[1].strip();switch(h.charAt(0)){case".":b.classes[h.slice(1)]=i;break;case"#":b.ids[h.slice(1)]=i;break;default:b.tags[h]=i;break}}},parseStops:function(a,b,c,d){var e=b.getAttribute("xlink:href");a.colorStops=[];if(e){e=e.replace(/^#/,"");this.getDef(c,e,function(b){if(a.colorStops.length==0)a.colorStops=b.colorStops})}var f=[];for(var g=0;g<b.childNodes.length;g++){var h=b.childNodes[g];if(h.tagName=="stop"){var i=parseFloat(h.getAttribute("offset"));if(h.getAttribute("offset").search(/%/)!=-1)i*=.01;var j=[i];j.color=a.color;for(var k=0;k<h.attributes.length;k++){var l=h.attributes[k];if(this.SVGMapping[l.nodeName])this.SVGMapping[l.nodeName](j,l.nodeValue,c,d)}this.applySVGStyle(j,h.getAttribute("style"),c,d);var m=h.getAttribute("id");if(m)this.setDef(c,m,j);f.push(j)}}if(f.length>0)a.colorStops=f},applySVGTransform:function(a,b,c,d){if(!b)return;a.transformList=[];var e=b.match(/[a-z]+\s*\([^)]*\)/ig);for(var f=0;f<e.length;f++){var g=e[f].split("(");var h=g[0].strip();if(this.SVGMapping[h]){var i=g[1].strip().slice(0,-1);this.SVGMapping[h](a,i,c,d)}}this.breakDownTransformList(a)},breakDownTransformList:function(a){var b=a.transformList;if(a.transformList.length==1){var c=b[0];if(c[0]=="translate"){a.x=c[1][0];a.y=c[1][1]}else if(c[0]=="scale"){a.scale=c[1]}else if(c[0]=="rotate"){a.rotation=c[1]}else if(c[0]=="matrix"){a.matrix=c[1]}else if(c[0]=="skewX"){a.skewX=c[1][0]}else if(c[0]=="skewY"){a.skewY=c[1][0]}else{return}a.transformList=null}},applySVGStyle:function(a,b,c,d){if(!b)return;var e=b.split(";");for(var f=0;f<e.length;f++){var g=e[f].split(":");var h=g[0].strip();if(this.SVGMapping[h]){var i=g[1].strip();this.SVGMapping[h](a,i,c,d)}}},getDef:function(a,b,c){if(a[b]&&a[b]instanceof Array){a[b].push(c)}else if(a[b]){c(a[b])}else{a[b]=[c]}},setDef:function(a,b,c){if(a[b]&&a[b]instanceof Array){for(var d=0;d<a[b].length;d++){a[b][d](c)}}a[b]=c},parseUnit:function(a,b,c){if(a==null){return null}else{return this.parseUnitMultiplier(a,b,c)*parseFloat(a.strip())}},parseUnitMultiplier:function(a,b,c){var d=this.getCmInPixels();if(a.search(/cm$/i)!=-1)return d;else if(a.search(/mm$/i)!=-1)return.1*d;else if(a.search(/pt$/i)!=-1)return.0352777778*d;else if(a.search(/pc$/i)!=-1)return.4233333333*d;else if(a.search(/in$/i)!=-1)return 2.54*d;else if(a.search(/em$/i)!=-1)return b.fontSize;else if(a.search(/ex$/i)!=-1)return b.fontSize/2;else if(a.search(/%$/i)!=-1)if(c=="x")return b.root.innerWidth*.01;else if(c=="y")return b.root.innerHeight*.01;else return b.root.innerSize*.01;else return 1},getCmInPixels:function(){if(!this.cmInPixels){var a=E("div",{style:{margin:"0px",padding:"0px",width:"1cm",height:"1cm",position:"absolute",visibility:"hidden"}});document.body.appendChild(a);var b=a.offsetWidth;document.body.removeChild(a);this.cmInPixels=b||38}return this.cmInPixels},getEmInPixels:function(){if(!this.emInPixels){var a=E("div",{style:{margin:"0px",padding:"0px",width:"1em",height:"1em",position:"absolute",visibility:"hidden"}});document.body.appendChild(a);var b=a.offsetWidth;document.body.removeChild(a);this.emInPixels=b||12}return this.emInPixels},getExInPixels:function(){if(!this.exInPixels){var a=E("div",{style:{margin:"0px",padding:"0px",width:"1ex",height:"1ex",position:"absolute",visibility:"hidden"}});document.body.appendChild(a);var b=a.offsetWidth;document.body.removeChild(a);this.exInPixels=b||6}return this.exInPixels},SVGMapping:{DEG_TO_RAD_FACTOR:Math.PI/180,RAD_TO_DEG_FACTOR:180/Math.PI,parseUnit:function(a,b,c){return SVGParser.parseUnit(a,b,c)},"class":function(a,b){a.className=b},marker:function(a,b,c){SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.marker=b})},"marker-start":function(a,b,c){SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.markerStart=b})},"marker-end":function(a,b,c){SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.markerEnd=b})},"marker-mid":function(a,b,c){SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.markerMid=b})},"clip-path":function(a,b,c){SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.clipPath=b})},id:function(a,b){a.id=b},translate:function(a,b){var c=b.split(/[\s,]+/).map(parseFloat);a.transformList.push(["translate",[c[0],c[1]||0]])},rotate:function(a,b){if(b=="auto"||b=="auto-reverse")return;var c=b.split(/[\s,]+/).map(parseFloat);var d=c[0]*this.DEG_TO_RAD_FACTOR;if(c.length>1)a.transformList.push(["rotate",[d,c[1],c[2]||0]]);else a.transformList.push(["rotate",[d]])},scale:function(a,b){var c=b.split(/[\s,]+/).map(parseFloat);var d=["scale"];if(c.length>1)d[1]=[c[0],c[1]];else d[1]=[c[0],c[0]];a.transformList.push(d)},matrix:function(a,b){var c=b.split(/[\s,]+/).map(parseFloat);a.transformList.push(["matrix",c])},skewX:function(a,b){var c=parseFloat(b)*this.DEG_TO_RAD_FACTOR;a.transformList.push(["skewX",[c]])},skewY:function(a,b){var c=parseFloat(b)*this.DEG_TO_RAD_FACTOR;a.transformList.push(["skewY",[c]])},opacity:function(a,b){a.opacity=parseFloat(b)},display:function(a,b){a.display=b},visibility:function(a,b){a.visibility=b},"stroke-miterlimit":function(a,b){a.miterLimit=parseFloat(b)},"stroke-linecap":function(a,b){a.lineCap=b},"stroke-linejoin":function(a,b){a.lineJoin=b},"stroke-width":function(a,b){a.strokeWidth=this.parseUnit(b,a)},fill:function(a,b,c,d){a.fill=this.__parseStyle(b,a.fill,c,a.color)},stroke:function(a,b,c,d){a.stroke=this.__parseStyle(b,a.stroke,c,a.color)},color:function(a,b,c,d){if(b=="inherit")return;a.color=this.__parseStyle(b,false,c,a.color)},"stop-color":function(a,b,c,d){if(b=="none"){a[1]=[0,0,0,0]}else{a[1]=this.__parseStyle(b,a[1],c,a.color)}},"fill-opacity":function(a,b){a.fillOpacity=Math.min(1,Math.max(0,parseFloat(b)))},"stroke-opacity":function(a,b){a.strokeOpacity=Math.min(1,Math.max(0,parseFloat(b)))},"stop-opacity":function(a,b){a[1]=a[1]||[0,0,0];a[1][3]=Math.min(1,Math.max(0,parseFloat(b)))},"text-anchor":function(a,b){a.textAnchor=b;if(a.setAlign){if(b=="middle")a.setAlign("center");else a.setAlign(b)}},"font-family":function(a,b){a.fontFamily=b},"font-size":function(a,b){a.fontSize=this.parseUnit(b,a)},__parseStyle:function(a,b,c,d){if(a.charAt(0)=="#"){if(a.length==4)a=a.replace(/([^#])/g,"$1$1");var e=a.slice(1).match(/../g).map(function(a){return parseInt(a,16)});return e}else if(a.search(/^rgb\(/)!=-1){var e=a.slice(4,-1).split(",");for(var f=0;f<e.length;f++){var g=e[f].strip();if(g.charAt(g.length-1)=="%")e[f]=Math.round(parseFloat(g.slice(0,-1))*2.55);else e[f]=parseInt(g)}return e}else if(a.search(/^rgba\(/)!=-1){var e=a.slice(5,-1).split(",");for(var f=0;f<3;f++){var g=e[f].strip();if(g.charAt(g.length-1)=="%")e[f]=Math.round(parseFloat(g.slice(0,-1))*2.55);else e[f]=parseInt(g)}var g=e[3].strip();if(g.charAt(g.length-1)=="%")e[3]=Math.round(parseFloat(g.slice(0,-1))*.01);else e[3]=Math.max(0,Math.min(1,parseFloat(g)));return e}else if(a.search(/^url\(/)!=-1){var h=a.match(/\([^)]+\)/)[0].slice(1,-1).replace(/^#/,"");if(c[h]){return c[h]}else{return"rgba(255,0,255,1)"}}else if(a=="currentColor"){return d}else if(a=="none"){return"none"}else if(a=="freeze"){return null}else if(a=="remove"){return null}else{return a}}}}